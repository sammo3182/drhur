

### 基础回归分析

## 导语

大家好！欢迎来到“Learning R with Dr. Hu and His Friends”!
今天，我们将学习如何通过R语言实现基础的回归分析。R作为主要由统计学家设计的语言，具有强大的数据分析能力，功能十分丰富，操作也很便捷。只要你具有相当的统计学知识，就能很快上手这个章节。

在开始之前，让我们先配置一下操作环境。首先，我们将当前使用的文件夹设置为工作路径，这能够让R知道接下来要调用的文件应当从哪里找到。
```{r}
setwd(dirname(rstudioapi::getActiveDocumentContext()$path))
```
当然，你也可以通过setwd函数来手动设置，可以按照setwd("D://xxx//xxx")的语法格式来输入正确的路径。

我们这次课程主要使用到3个包：
readxl：能够帮助你读取Excel文档；
stargazer：可以以LaTeX、HTML、ASCII代码等形式输出回归分析结果；
ggplot2:强大的数据可视化工具（对此我们另有章节进行教学）。
如果你已经安装好它们了，那就先打开它们吧～
```{r}
library(readxl) # R package for import excel files
library(stargazer) # R package for making regression table
library(ggplot2) # R package for plotting
```
做好这些准备后，我们正式开始今天的回归分析之旅！

## 课程案例
本节所使用的数据来自于对中国、日本的社会调查，我们将此为本节的教学案例。首先，让我们通过data()函数来调取已经内置于drhur中的数据。
```{r}
data<- read_excel("WVS_CHN.xlsx", sheet="Sheet1")
```

通过View(data)，让我们更好地观察数据中的信息。其中，调查数据中编号为Q46的问题展示如下：

Q46 Taking all things together, would you say you are
 1 Very happy
 2 Rather happy
 3 Not very happy
 4 Not at all happy
 如何更聚焦于该问题的数据呢？此时可以用table()函数。首先我们为Q46赋值（在此类似于划出数据范围），随后通过table(Q46)便能为其画出联列表。
```{r}
Q46 <- data$Q46
table(Q46)
```

 通过ifelse()函数对happiness做一个赋值处理，便能通过数值来理解人们感到的幸福程度：1-4表示从不幸福到幸福的程度表达。
 
```{r}
happiness <- ifelse(Q46 < 0, NA, 5-Q46) 
table(happiness)
```
此处ifelse()实现的操作是“如果遇到Q46中的值小于0，则将该值赋为NA（不存在），其余值赋为5-原值”。

类似地，我们来看一看Q49。

Q49 All things considered, 
how satisfied are you with your life as a whole these days? 
1 - 10, Completely dissatisfied - Completely satisfied

如果我们想通过table()函数将其呈现出来，则可通过如下代码实现：
```{r}
Q49 <- data$Q49
table(Q49)
recent_life_satisfaction <- ifelse(Q49 < 0, NA, Q49)
table(recent_life_satisfaction)
```

接下来，我们可以对其他问题也做类似的处理，一起来练习一下今天新学的内容吧！

Q50 How satisfied are you with the financial situation of your household?
1 - 10, Completely dissatisfied - Completely satisfied

代码演示：
```{r}
Q50 <- data$Q50
table(Q50)
househould_financial_satisfactiion <- ifelse(Q50 < 0, NA, Q50)
table(househould_financial_satisfactiion)
```

Q112. How would you place your views on corruption in your country?
1 - 10, There is no corruption in my country - There is abundant corruption in my country

代码演示：
```{r}
Q112 <- data$Q112
table(Q112)
corruption <- ifelse(Q112 < 0, NA, Q112)
table(corruption)
```

Q164. How important is God in your life? 
1 - 10, Not at all important - Very important

代码演示：
```{r}
Q164 <- data$Q164
table(Q164)
god_is_important <- ifelse(Q164 < 0, NA, Q164)
table(god_is_important)
```

该社会调查中涉及到受访者的基本信息（性别、年龄、地域等），我们亦可以沿用上述方法对数据进行结构化处理，并有针对地调取出数据。

例如，针对受访者的性别：
Q260 Respondent's Sex

```{r}
Q260 <- data$Q260
table(Q260)
male <- ifelse(Q260==1,1,0)
table(male)
```

针对受访者的年龄：
Q262 Respondent's Age

```{r}
Q262 <- data$Q262
table(Q262)
age <- Q262
```

针对受访者的所属省份：
region province

```{r}
region <- data$N_REGION_ISO
```

面对众多省份，我们可以通过attach()函数实现变量与数据集的关联，以更方便地检索我们所需要的数据。
```{r}
attach(data)
```
之后，你就能通过Data$<省份>来调用相应地区的数据啦。如果你想取消这个操作，通过detach(data)便能够取消关联。

# 数据框
为了更加直观地观察数据，我们还可以将不同类型数据组合成数据框。
假如我们想要对比数据中的开始时间（Start Time）、结束时间（End Time）数据：
```{r}
start_time <- floor(K_TIME_START) + (K_TIME_START - floor(K_TIME_START))/0.6
end_time <- floor(K_TIME_END) + (K_TIME_END - floor(K_TIME_END))/0.6
```
我们接下来就要用到data.frame函数。data.frame函数能够将不同的变量合并成为数据框，以类似于Excel的排列方式展示数据：
```{r}
data_regression <- cbind.data.frame(start_time, end_time)
```
在这里，我们将起始时间数据以列的形式合并为数据框。其中，cbind的意思为按列排列，如果你想按行排列，则可以将其改为rbind。


## 线性回归模型：普通最小二乘法（OLS）
要分析变量间的线性，统计学给予了十分多元的方法。其中，普通最小二乘法（OLS）既是我们所熟知的，也是最常用的分析方法。接下来，我们就进行一个线性回归的最基础的实现：
# 回归分析函数
lm函数是最基础的拟合线性回归函数。我们将上文提及的起止时间数据带入：
```{r}
M_01 <- lm(end_time ~ start_time, data = data)
```
就能运用lm函数分析end_time和start_time的关系了。在代码中，“~”是连接解释变量与被解释变量的符号，“~”后的是解释变量。如果你要假如多个解释变量，则用“+”将它们连接即可，例如“y ~ x + z ”。
# 分析总结
通过summary函数，你就能查看刚刚回归分析的结果：
```{r}
summary(M_01)
```
怎么洋，操作起来很简单吧？

# 用stargazer制作漂亮的图表！
光在Rstudio里查看分析结果是不够的，我们得想办法把这份统计分析结果分享出去：
```{r}
stargazer(M_01, title="Trial Regression", type="text", out="Trial Regression.html")
```
运用stargazer函数，能够一步输出报告。stargazer的基础语法为stargazer(<所要输出数据的名称>, <选项1>, <选项2>, ……, out="<输出文件名称>")。我们在本次生成中使用了两个选项，一个是将标题设置为
Trial Regression（title="Trial Regression"），另一个是将输出形式设置为文本（type="text"），最后选择了以html形式输出（out="Trial Regression.html"）。

到这里，你就已经通过R体验了回归分析的最简单全流程啦！


## 知识回顾
在开始实际操作前，我们先简要回顾一下OLS线性回归的一些基础知识。
# 高斯-马尔可夫定理(Gauss-Markov Theorem)的假设
高斯-马尔可夫定理在数学意义上支撑着OLS线性回归的有效性。我们在分析时要遵循其成立的5个假设。
假设1:参数均为常数。
假设2:样本是随机抽样的。
假设3:在样本中，没有独立变量是常数，独立变量之间不能完全共线。
假设4:误差项的均值为0，与其他变量不存在相关性。
假设5:误差项的方差是一个恒定值，且不受独立变量的影响。

只有所要分析的数据符合以上5个假设，OLS线性回归才能进行。
# 最佳线性无偏估计量
良好的线性模型能让我们尽力去获得最佳线性无偏估计量(BLUE, Best Linear unbiased estimator)，即在具有线性、无偏性的前提下，尽可能地让方差最小。

# 回归诊断
误差项在理论上应当与解释变量无关，但是否真是如此？如果该回归符合高斯-马尔科夫定理，其误差项应该具有如下性质：
1.残差是一个期望为0的随机变量。
2.对于所有的预测，误差项的方差应当相等，即误差项方差不随解释变量的取值变化而变化。
3.误差项应当各个值相互独立，符合正态分布。

# 知识拓展
如果还想了解更多关于高斯-马尔可夫定理、OLS的知识，可以通过以下链接做一个拓展阅读～
https://zhuanlan.zhihu.com/p/34119477
https://zhuanlan.zhihu.com/p/33899560

## 进阶分析
目前，我们生成的统计分析还只是文本的形式，如果能够使用图表来呈现数据关系，将会使得数据本身和一些统计量的特征浮现出来。在这里，我们要用到ggplot2包来实现简单的数据可视化。
# 散点图
ggplot函数是生成图形的一个基础函数，我们现在就以起止时间的关系来生成散点图：
```{r}
ggplot(data = data, aes(x = start_time, y = end_time)) +
  geom_jitter(width=0.0, height=0.0) +
  xlab('start_time') +
  ylab('end_time') +
  ggtitle('Jitter Plot')
```
其中：
data代表所选数据源；
aes是aesthetic的缩写，表示用何种视觉形式呈现信息，我们在这里将start_time设置为x轴，将end_time设置为y轴；
geom_jitter函数表示以抖动点形式生成，即把位置重叠的点以较小的距离错位，好让每个点都能被视觉观察到；
xlab、ylab函数起到了注释的功能，即分别在x轴、y轴标注了该变量的名称；
ggtitle函数则为这张图确定了名称。

或者，我们也可以直接用plot函数生成散点图：
```{r}
plot(start_time, end_time)
```

# 点线结合
当我们把散点图画出来后，就可以以同样的数据源添加上线性回归得到的回归线：
```{r}
plot(start_time, end_time)
abline(M_01)
```

# 残差分析
在回归分析时，我们时常借助残差分析来判断该回归结果是否有效。此时，可以使用residuals函数来计算残差，并画出start_time和残差之间的散点图。
```{r}
y.res<-residuals(M_01)
plot(start_time, y.res)
```

# 假设检验的综合方案
我们也可以直接通过plot函数将回归结果以四幅图的形式展现出来：
```{r}
plot(M_01)
```

生成的图形如上所示，下面对生成的图形进行解释：
OLS回归的统计假设为：正态性，独立性，线性，同方差性，各图对应着对该回归模型不同性质的考察。
1、线性 Residuals vs Fitted
这幅图展示了预测值与残差之间的关系。若应变量与自变量线性相关，那么残差值与拟合值就没有任何系统关联。在图中可以看到有一个明显的曲线关系，这说明可能要对回归模型添加一个二次项

2、正态性 Normal Q-Q 
正态QQ图用于检验残差正态性。如果满足正态假设，那么图上的点就应该均匀的落在呈45°角的直线上（图中虚线），不然就违反了正态性的假设。

3、同方差性 Scale-Location 
这是一副位置尺度图。如果满足同方差性，那么图中水平线周围的点应该随机分布。

4、Residuals VS Leverage 
这是残差与杠杆图，从图形中可以鉴别出离群点，高杠杆值点和强影响点。
如果有离群点，则表明拟合回归模型对其预测效果不佳。
如果有高杠杆值点，则表明是一个异常的预测变量值的组合，即这是一个预测变量空间中离群点。 如果有强影响点，则表明它对模型参数的估计产生的影响过大，非常不成比例。

想要了解更多关于回归诊断图的解读，可以通过链接查看：
https://www.jianshu.com/p/464bd93c3410

## 检验回归的多元方法

# qqPlot()的正态性检验
与基础包中的plot()相比，qqPlot()函数提供了更为精确的正态性假设检验的方法，它画出了在n-p-1个自由度的t分布下的残差，让我们打开car包，来尝试画出该分布：
```{r}
library(car)
qqPlot(M_01)
```
# crPlots()的线性检验
通过成分残差图也称偏残差图，可以看看因变量与自变量之间是否呈线性关系，也可以看看是否有不同于已设定线性模型的系统偏差，图形可以使用car包中的crPlots()函数绘制：
```{r}
crPlots(M_01)
```

# 绘制最佳拟合曲线散点图
spreadlevelPlot()函数则会绘制最佳拟合曲线散点图，如果违反同方差假设，你将会看到一个非水平的曲线：
```{r}
spreadLevelPlot(M_01)
```

# 异方差检验
通过bptest函数，我们可以得到一个学生化（studentized）结果，来查看数据是否存在异方差性。
```{r}
bptest(M_01)  
```
在这里，我们的 0假设是同方差。

# 残差常数检验
或者，我们也可以用ncvTest函数来检查残差的方差是否为常数：
```{r}
ncvTest(M_01) 
```
在这里，我们的0假设是方差不变。

# 共线性检验
通过vif函数，我们可以查看各自变量是否存在共线性问题。如果VIF>10，表明模型中有很强的共线性问题。
```{r}
vif(M_01)
```

## 结语
通过本章节的学习，你应该能领略到运用R语言进行线性回归的便利性。作为一款主要面向统计分析设计的语言，R往往通过十分简洁的代码就能调用十分丰富的统计分析功能。不过，如何更好地使用这些功能，还需要你加强对统计学知识的掌握，才能让这些统计工具如虎添翼！

如果你在本次学习中感觉意犹未尽，可以点开下方链接去拓展更多关于基于R的线性回归知识～
https://zhuanlan.zhihu.com/p/23310623
https://www.jianshu.com/p/464bd93c3410
https://sammo3182.github.io/slides_gh/slides/courses/analysisOfPoliticalData/09_assumptions.html#1
