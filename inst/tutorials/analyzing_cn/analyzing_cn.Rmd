---
title: "Dr. Hu's R Workshop"
output: 
  learnr::tutorial:
    progressive: true
    allow_skip: true
runtime: shiny_prerendered
---

```{r setup, include=FALSE}
library(learnr)
library(gapminder)
library(car)
library(arm)
library(summarytools)
library(performance)
library(nnet)
library(tibble)
library(tidyverse)
```

# è¯¾ç¨‹ III: æ•°æ®åˆ†æ

å“ˆï¼å¤§å®¶å¥½ï¼Œæˆ‘æ˜¯èŒèŒï¼æ¬¢è¿æ¥åˆ°â€œLearning R with Dr. Hu and His Friendsâ€!

ç›¸ä¿¡ç»è¿‡å‰ä¸¤å¤©çš„ä¿®ç‚¼ï¼Œä½ å·²ç»æŒæ¡äº†å¤„ç†æ•°æ®çš„åŸºæœ¬åŠŸèƒ½ï¼Œä½†æƒ³è¦ç»ƒå°±ç»ä¸–æ­¦åŠŸéœ€ç»å†ä¹ä¹å…«åä¸€éš¾ï¼Œæ–¹å¯æˆä¸º*æ–—æˆ˜ç¥ä½›*ğŸŒ»ï¼Œç°åœ¨å°±è®©æˆ‘ä»¬ä¸€èµ·é€šå¾€`R expert`ä¹‹æ—…çš„ç¬¬ä¸‰ç«™ï¼Œæå‡æˆ˜æ–—å€¼å§ï¼

## çŸ¥è¯†ç‚¹

æœ¬ç« èŠ‚æˆ‘ä»¬å°†è¦å­¦ä¹ çš„çŸ¥è¯†ç‚¹æœ‰ä»¥ä¸‹å‡ ä¸ªæ–¹é¢ï¼š

1. æè¿°ç»Ÿè®¡å­¦:
    + ç»Ÿè®¡åˆ†å¸ƒçš„çŸ©é˜µ
    + è·¨å˜é‡æ•°æ®æ¡†
2. åˆ†æç»Ÿè®¡å­¦:
    + äºŒå…ƒåˆ†æ (t æ£€éªŒ, ç›¸å…³æ€§åˆ†æ, æ–¹å·®åˆ†æ)
    + å¤šå˜é‡åˆ†æ (æ™®é€šæœ€å°äºŒä¹˜æ³•ï¼ˆOLSï¼‰, æœ€å¤§ä¼¼ç„¶ä¼°è®¡ï¼ˆMLE)ï¼‰

## è¯¾ç¨‹å¯¼å…¥

ç”± [Hans Rosling çš„ TED æ¼”è®²](https://www.ted.com/talks/hans_rosling_shows_the_best_stats_you_ve_ever_seen?utm_campaign=tedspread--b&utm_medium=referral&utm_source=tedcomshare) æ™®åŠçš„äººå£æ•°æ®.

```{r toy, exercise = TRUE}
library(tibble)
library(gapminder)
glimpse(gapminder)
```

>èŒèŒï¼šå•Š, ç¨€æœ‰æ•°æ®ï¼å®ƒä»¬æ˜¯å¤šä¹ˆçš„é²œç¾å¤šæ±ï¼ï¼ä½†å¦‚ä½•...æ‰èƒ½è®©å®ƒä»¬è¯´è¯ï¼Ÿæ¥ä¸‹æ¥å°±è®©æˆ‘ä»¬ä¸€èµ·è·å¾—è®©æ•°æ®è¯´è¯çš„*è‘µèŠ±å®å…¸*ğŸŒ»ï¼


## æè¿°æ€§ç»Ÿè®¡

### çŸ©é˜µ

+ å¹³å‡å€¼

+ æ–¹å·®ï¼šå½“æ•°æ®åˆ†å¸ƒæ¯”è¾ƒåˆ†æ•£ï¼ˆå³æ•°æ®åœ¨å¹³å‡æ•°é™„è¿‘æ³¢åŠ¨è¾ƒå¤§ï¼‰æ—¶ï¼Œå„ä¸ªæ•°æ®ä¸å¹³å‡æ•°çš„å·®çš„å¹³æ–¹å’Œè¾ƒå¤§ï¼Œæ–¹å·®å°±è¾ƒå¤§ï¼›å½“æ•°æ®åˆ†å¸ƒæ¯”è¾ƒé›†ä¸­æ—¶ï¼Œå„ä¸ªæ•°æ®ä¸å¹³å‡æ•°çš„å·®çš„å¹³æ–¹å’Œè¾ƒå°ã€‚å› æ­¤æ–¹å·®è¶Šå¤§ï¼Œæ•°æ®çš„æ³¢åŠ¨è¶Šå¤§ï¼›æ–¹å·®è¶Šå°ï¼Œæ•°æ®çš„æ³¢åŠ¨å°±è¶Šå°ã€‚

+ ååº¦ï¼ˆskewnessï¼‰ï¼Œæ˜¯ç»Ÿè®¡æ•°æ®åˆ†å¸ƒåæ–œæ–¹å‘å’Œç¨‹åº¦çš„åº¦é‡ã€‚ååº¦å®šä¹‰ä¸­åŒ…æ‹¬å³ååˆ†å¸ƒï¼ˆä¹Ÿå«æ­£ååˆ†å¸ƒï¼Œå…¶ååº¦>0ï¼‰ï¼Œæ­£æ€åˆ†å¸ƒï¼ˆååº¦=0ï¼‰ï¼Œå·¦ååˆ†å¸ƒï¼ˆä¹Ÿå«è´Ÿååˆ†å¸ƒï¼Œå…¶ååº¦<0ï¼‰

+ å³°åº¦ï¼ˆkurtosisï¼‰ï¼šè¡¨å¾æ¦‚ç‡å¯†åº¦åˆ†å¸ƒæ›²çº¿åœ¨å¹³å‡å€¼å¤„å³°å€¼é«˜ä½çš„ç‰¹å¾æ•°ã€‚ç›´è§‚çœ‹æ¥ï¼Œå³°åº¦åæ˜ äº†å³°éƒ¨çš„å°–åº¦ï¼Œè®¡ç®—æ–¹æ³•ä¸ºéšæœºå˜é‡çš„å››é˜¶ä¸­å¿ƒçŸ©ä¸æ–¹å·®å¹³æ–¹çš„æ¯”å€¼ã€‚

>èŒèŒï¼šå’¦ï½ï½ æ— å½¢è£…é€¼ï¼Œæœ€ä¸ºè‡´å‘½ã€‚è¿™äº›æ¦‚å¿µçœ‹èµ·æ¥ç¥ç§˜è«æµ‹çš„ï¼Œå’±ä¹Ÿä¸æ‡‚ï¼Œå’±ä¹Ÿä¸æ•¢é—®ğŸ¤«

```{r moments, exercise = TRUE, exercise.eval = TRUE}
library(tidyverse)
library(moments)
gapminder %>%
  summarise(mean_life = mean(lifeExp),
            median_life = median(lifeExp),
            iqr_life = IQR(lifeExp),
            #  IQR = quantile(x, 3/4) - quantile(x, 1/4)
            skew_life = skewness(lifeExp),
            kurtosis_life = kurtosis(lifeExp))
```

>èŒèŒï¼šè¿˜è®°å¾—æˆ‘ä¿©ä¹‹é—´å…³äº `%>% `çš„å°ç§˜å¯†å—ğŸ¤« 

```{r moments-solution}
library(broom) #broomæ˜¯tidyverseç³»åˆ—åŒ…ä¹‹ä¸€ï¼Œå¯ä»¥ä½¿å»ºæ¨¡ç»“æœå˜é‡æ›´åŠ æ•´æ´ã€‚
sum_OneVar <- summary(gapminder$lifeExp) %>% tidy
```

### æ€»ç»“æ•°æ®

```{r descriptive, exercise = TRUE}
library(summarytools)
freq(gapminder)
```

```{r descriptive-solution}
dfSummary(gapminder)
```

### æ•°æ®å¯è§†åŒ–

```{r descriptivePretty, eval = FALSE, include = FALSE}
print(dfSummary(gapminder,
                graph.magnif = 0.3,
                trim.strings = TRUE,
                plain.ascii = FALSE,
                valid.col = FALSE,
                na.col = FALSE),
      method = 'render')
```


```{r excel, out.width = "100%", echo = FALSE}
knitr::include_graphics("images/dfSummary.png")
```

## çº¿æ€§å›å½’ç»Ÿè®¡

### äºŒå…ƒåˆ†æ

>èŒèŒï¼šå‘€ï¼æ‰åˆšåˆšé—¯å…³å°±é‡åˆ°äº†é“¶è§’å¤§ç‹â€”â€”å›å½’ç»Ÿè®¡ã€‚é“¶è§’å¤§ç‹å‡ºäº†ä¸€é“éš¾é¢˜ï¼šä¸€ä¸ªå˜é‡å’Œå¦ä¸€ä¸ªå˜é‡ç›¸å…³å—ï¼Ÿ

1. å®ƒä»¬çš„å¹³å‡å€¼ç›¸è¿‘å—?
1. ä¸¤ä¸ªå˜é‡ç‹¬ç«‹äºå½¼æ­¤å—?
1. æ–¹å·®é‡è¦å—ï¼Ÿ

### äº¤å‰è¡¨

```{r crossTable}
library(summarytools)
gapminder$coldWar <- gapminder$year <= 1992
gapminder$asia <- gapminder$continent == "Asia"
ctable(gapminder$asia, gapminder$coldWar)
```
>èŒèŒï¼šæ‚„æ‚„å‘Šè¯‰ä½ filterä¸selectå‡½æ•°ä¹Ÿå¯ä»¥å®Œæˆä»»åŠ¡âœ…


### å¹³å‡å·®å¼‚

é“¶è§’å¤§ç‹ï¼šæ¥æ‹›å§ï¼è¯·é—®å†·æˆ˜å‰åçš„äººå‡å¯¿å‘½æ˜¯å¦å˜åŒ–å—ï¼Ÿ

$H_{0}: \bar{LifeExpctancy}_{prio 1991} = \bar{LifeExpctancy}_{post 1991},\ \alpha = .05$

```{r ttest, exercise = TRUE}
gapminder$coldWar <- gapminder$year <= 1992
gapminder %>%
  group_by(coldWar) %>% #æ ¹æ®coldWaråˆ†ç»„
  summarise(mean(lifeExp)) 
```
>èŒèŒï¼šå®é™…åº”ç”¨ä¸­ï¼Œgroup_byä¸summariseå‡½æ•°æ­é…ä½¿ç”¨é£å‘³æ›´ä½³å“Ÿï¼

```{r ttest-solution}
t.test(gapminder$lifeExp[gapminder$year <= 1991], gapminder$lifeExp[gapminder$year > 1991])
t.test(gapminder$lifeExp[gapminder$year <= 1991], gapminder$lifeExp[gapminder$year > 1991], alternative = "greater", conf.level = .99) #t æ£€éªŒ
```

### ç›¸å…³æ€§

é“¶è§’å¤§ç‹: ä¸€ä¸ªå›½å®¶çš„äººå‡å¯¿å‘½æ˜¯å¦å’Œäººå‡å›½æ°‘ç”Ÿäº§æ€»å€¼ç›¸å…³(äººå£å‘¢ï¼‰ï¼Ÿ

$H_{0}: \rho_{(LifeExpectancy, GDP)} = 0,\ \alpha = .05$

```{r corr, exercise = TRUE}
cor.test(gapminder$lifeExp, gapminder$gdpPercap) #ç›¸å…³æ€§æ£€éªŒ
```

### å¤šå˜é‡ç›¸å…³æ€§åˆ†æ

```{r corrplot}
select(gapminder, year, lifeExp, gdpPercap, pop) %>% 
  cor %>% # ç›¸å…³æ€§åˆ†æ
  corrplot::corrplot.mixed() # ç›¸å…³æ€§å›¾
```
>èŒèŒï¼šè¿™é‡Œåˆç”¨åˆ°äº†selectå‡½æ•°å“Ÿï¼

### æ–¹å·®åˆ†æ(ANOVA)

é“¶è§’å¤§ç‹: ä¸åŒå¤§æ´²çš„äººå‡å¯¿å‘½ä¸åŒå—(ä¸åŒå¹´ä»½å‘¢)ï¼Ÿ

$H_{0}: \mu_{Africa} = \mu_{Americas} = ... = \mu_{Oceania},\ \alpha = .05$

```{r anova, exercise = TRUE}
aov(lifeExp ~ continent, data = gapminder) %>%
  summary() #æ–¹å·®åˆ†æ
```

### åæ–¹å·®åˆ†æ(ANCOVA)

```{r anova-solution}
aov(lifeExp ~ continent + as.factor(year), data = gapminder) %>%
  summary()
```


### æœ€å°äºŒä¹˜æ³•åˆ†æ(OLS)

é“¶è§’å¤§ç‹: ä¸€ä¸ªå›½å®¶çš„äººå‡å¯¿å‘½å¦‚ä½•åœ¨ä¸åŒå¤§æ´²å’Œå¹´ä»½ä¹‹é—´å˜åŠ¨?

```{r ols, exercise = TRUE}
gapminder %>% count(lifeExp, continent, year)
```

```{r ols-solution}
lm(lifeExp ~ continent + year, data = gapminder) %>%  
  summary() 
```

>èŒèŒï¼š æ•²é»‘æ¿å•¦ï¼OLSä¸ºçº¿æ€§å›å½’åˆ†æï¼Œé€šå¸¸ç”¨äºè¿ç»­æ€§å› å˜é‡ï¼Œ`ï½`å·¦ä¾§ä¸ºå› å˜é‡ï¼Œå³ä¾§ä¸ºè‡ªå˜é‡ã€æ§åˆ¶å˜é‡ã€‚é‚£åˆ†ç±»å˜é‡åˆåº”è¯¥ä½¿ç”¨ä»€ä¹ˆå›å½’å‘¢ï¼Ÿ


### å˜é‡å˜æ¢

+ æ§åˆ¶æ—¶é—´

$t + t^2$

```{r time, exercise = TRUE}
lm(lifeExp ~ gdpPercap + year, data = gapminder) %>%
  summary()
```


```{r time-solution}
lm(lifeExp ~ gdpPercap + year + I(year^2), data = gapminder) %>%
  summary()
```

+ å…¶ä»–å˜æ¢

`sqrt(var)`, `log(var)`

### æ ‡å‡†åŒ–

```{r standardized}
library(arm)
lm(lifeExp ~ gdpPercap + year + I(year^2), data = gapminder) %>%
  standardize() %>%
  summary()
```


### æ¡ä»¶æ•ˆåº”

é“¶è§’å¤§ç‹ï¼šä¸€ä¸ªå›½å®¶çš„äººå‡å›½æ°‘ç”Ÿäº§æ€»å€¼å¯¹äººå‡å¯¿å‘½çš„å½±å“æ˜¯å¦éšç€äººå£æ•°é‡çš„å˜åŒ–è€Œå˜åŒ–?

```{r interact, exercise = TRUE}
lm(lifeExp ~ gdpPercap + year, data = gapminder) %>%
  summary()
```


```{r interact-solution}
lm(lifeExp ~ gdpPercap * pop + year, data = gapminder) %>% 
  summary()
```

>èŒèŒï¼šè®°åœ¨å°æœ¬æœ¬ä¸Šçš„â€”â€”åœ¨è¿›è¡Œæ¡ä»¶æ•ˆåº”æ£€éªŒæ—¶ï¼Œæ¨¡å‹ä¸­å¿…é¡»åŒæ—¶åŒ…å«æ‰€éœ€çš„ä¸¤ä¸ªåŸºæœ¬æ¦‚å¿µå“Ÿï¼å‘€ï¼åˆšé€èµ°é“¶è§’å¤§ç‹ï¼Œå®ƒå“¥â€”â€”é‡‘è§’åˆæ¥äº†ï¼Œç»™æˆ‘å†²ï¼

## å¹¿ä¹‰é€»è¾‘å›å½’

é‡‘è§’å¤§ç‹: åœ¨æ§åˆ¶äººå£çš„å‰æä¸‹ï¼Œä¸€å›½çš„äººå‡GDPæ˜¯å¦å†³å®šäº†è¯¥å›½çš„äººå‡é¢„æœŸå¯¿å‘½é«˜äºå…¨çƒå¹³å‡æ°´å¹³ï¼Ÿ

```{r logit, exercise = TRUE}
glimpse(mtcars) #æŸ¥çœ‹æ•°æ®æ¦‚è¦
glm(vs ~ gear + wt + mpg, data = mtcars, family = "binomial") %>% #tipsï¼švsæ˜¯å®šç±»ï¼ˆ0/1ï¼‰å˜é‡
  summary()
```

### é˜é‡Š

```{r margin, exercise = TRUE}
glm(vs ~ gear + wt + mpg, data = mtcars, family = "binomial") %>%
  ggeffects::ggpredict()
```

### æœ‰åºå›å½’

```{r ologit, exercise = TRUE}
polr(as.factor(gear) ~ wt + mpg, data = mtcars) %>% # tips:gearä¸ºå®šåºå˜é‡
  summary()
```

```{r ologit-solution}
library(ordinal)
clm(as.factor(gear) ~ wt + mpg, data = mtcars) %>%
  summary()
```


### å¤šé¡¹åˆ†å¸ƒ

```{r mlogit, exercise = TRUE}
library(nnet)
multinom(as.factor(cyl) ~ wt + mpg, data = mtcars) %>%
  summary()
```


### æ³Šæ¾åˆ†å¸ƒ

```{r poisson, exercise = TRUE}
df_poisson <- data.frame(counts = c(18, 17, 15, 20, 10, 20, 25, 13, 12),
                         outcome = gl(3, 1, 9),
# Generate factors by specifying the pattern of their levels.
                         treatment = gl(3, 3))
glm(counts ~ outcome + treatment,
               family = poisson(),
               data = df_poisson) %>%
  summary()
```


## å›å½’ç»“æœåˆ†æ

+ æ®‹å·®
+ å¼‚å¸¸å€¼
+ å¼‚æ–¹å·®æ€§
+ å¤šé‡å…±çº¿æ€§
+ è‡ªç›¸å…³æ€§

......

### æ®‹å·®

```{r residual, exercise = TRUE}
fit <- lm(lifeExp ~ gdpPercap + year, data = gapminder)
res <- resid(fit) # æ®‹å·®åˆ†æ
```

```{r residual-solution}
plot(fit, which  = 1) # plotå‡½æ•°ç”¨äºç”»å‡ºæ®‹å·®åˆ†æå›¾
```

### å¼‚å¸¸å€¼

```{r outlier, exercise = TRUE}
library(car)
outlierTest(fit)
# car::qqPlot(fit)
```

### å¼‚æ–¹å·®æ€§

```{r heter, exercise = TRUE}
ncvTest(fit)
```

### å¤šé‡å…±çº¿æ€§

```{r multi, exercise = TRUE}
vif(fit)
```

### è‡ªç›¸å…³æ€§

```{r durbin, exercise = TRUE}
durbinWatsonTest(fit)
```


### å¾ˆé…·çš„å¿«æ·æ–¹å¼

```{r performance, exercise = TRUE}
library(performance)
model_performance(fit)
check_normality(fit)
check_outliers(fit)
```

>èŒèŒï¼šå¿«æ·æ–¹å¼åœ¨æ‰‹ï¼Œè£…é€¼æˆ‘æœ‰ï¼Œå˜»å˜»ğŸ¤«

## æ€»ç»“

1. æè¿°:
    + `ctable`
    + `cor`
    + `aov`
2. åˆ†æ: `lm/glm/clm/multinom(Y ~ Xs, data)`

## è°¢è°¢ï¼

<i class="fa fa-envelope fa-lg"></i>&nbsp; [yuehu@tsinghua.edu.cn](mailto:yuehu@tsinghua.edu.cn)

<i class="fa fa-globe fa-lg"></i>&nbsp; https://sammo3182.github.io/

<i class="fab fa-github fa-lg"></i>&nbsp; [sammo3182](https://github.com/sammo3182)
