---
title: "Dr. Hu's R Workshop"
output: 
  learnr::tutorial:
    progressive: true
    allow_skip: true
runtime: shiny_prerendered
---


```{r setup, include=FALSE}
library(learnr)
library(tidyverse)
library(gapminder)
```

# è¯¾ç¨‹ II: æ•°æ®æ•´ç†

å“ˆï¼å¤§å®¶å¥½ï¼Œæˆ‘æ˜¯èŒèŒï¼æ¬¢è¿æ¥åˆ°â€œLearning R with Dr. Hu and His Friendsâ€!
æ­å–œä½ æˆåŠŸå®Œæˆç¬¬ä¸€å…³â€”â€”æ•°æ®è¾“å…¥ä¸è¾“å‡ºï¼Œæ¥ä¸‹æ¥å°±è®©æˆ‘ä»¬å¼€å¯`R expert`çš„ç¬¬äºŒç«™ä¹‹æ—…å§ã€‚æœ¬æ¬¡é—¯å…³éœ€è¦å…·å¤‡æ•°æ®å½’çº³å’Œæå–çš„æŠ€èƒ½å“Ÿï¼Œè¯·è®¤çœŸå­¦ä¹ ï¼

## ä»Šå¤©çš„å¤§boss

ç”± [Hans Rosling çš„ TED æ¼”è®²](https://www.ted.com/talks/hans_rosling_shows_the_best_stats_you_ve_ever_seen?utm_campaign=tedspread--b&utm_medium=referral&utm_source=tedcomshare) æ™®åŠçš„äººå£æ•°æ®ã€‚

```{r toy, exercise = TRUE}
library(gapminder)
gapminder
```

## æ•°æ®å½’çº³

### åˆæ¢æ•°æ®
```{r glimpse, exercise = TRUE}
head(gapminder, n = 6) # æŸ¥çœ‹æ•°æ®æ¡†ä¸­çš„å‰6è¡Œ

str(gapminder)  #æŸ¥çœ‹æ•°æ®æ¡†å½“ä¸­æœ‰å“ªäº›å˜é‡ä»¥åŠå˜é‡çš„ç±»å‹ï¼š
```

### ç³»ç»Ÿæ¢ç´¢

å—¨ï¼Œæˆ‘æ˜¯ä¸€åä¸“å®¶~ æˆ‘æƒ³ä»ç³»ç»Ÿçš„è§†è§’äº†è§£æ•°æ®, ä¾‹å¦‚æ‰¾åˆ°

* è§‚å¯Ÿæ•°æ®å¤§å°
* å˜é‡çš„åå­—åŠæ•°é‡
* æˆ–è€…æ•´ä¸ªæ•°æ®å¸§çš„ç»“æ„

```{r systemView, exercise = TRUE}
gapminder
```

```{r systemView-solution}
nrow(gapminder) # è·å–æ•°æ®çš„è¡Œæ•°
ncol(gapminder) # è·å–æ•°æ®çš„åˆ—æ•°
names(gapminder) # è·å–å˜é‡å/åˆ—å
str(gapminder) # è·å–å˜é‡åã€å˜é‡åç±»å‹ã€è¡Œæ•°ã€åˆ—æ•°
```


### äº†è§£å˜é‡

é—®: ç»™æˆ‘è®²è®²æ•°æ®é›†ä¸­çš„äººå£å˜é‡, æ¯”å¦‚è¯´, æˆ‘ä»¬æœ‰å¤šå°‘ä¸ªå›½å®¶çš„äººå£æ•°æ®, å¹³å‡å€¼æ˜¯å¤šå°‘, å“ªä¸ªå›½å®¶çš„äººå£æœ€å¤šï¼æœ€å°‘, è¿˜æœ‰å…¶ä»–å†…å®¹! å¯¹äº†,  `pop` è¢«ä¿å­˜æˆäº†ä»€ä¹ˆå½¢å¼å‘¢ï¼Ÿ

```{r variable, exercise = TRUE}
head(gapminder$year, n = 10) #æŸ¥çœ‹å¹´ä»½å‰10è¡Œ
```

```{r variable-solution}
mean(gapminder$year, na.rm = TRUE) #æ±‚å–å¹´ä»½çš„å¹³å‡å€¼ï¼Œna.rm = TRUEè¡¨ç¤ºå¿½ç•¥NA
median(gapminder$year) #æ±‚å–å¹´ä»½çš„ä¸­é—´å€¼
min(gapminder$year) #æ±‚å–å¹´ä»½çš„æœ€å°å€¼
max(gapminder$year) #æ±‚å–å¹´ä»½çš„æœ€å¤§å€¼
length(gapminder$year) #æ±‚å–å¹´ä»½çš„é•¿åº¦ï¼ˆæ­¤å¤„ä¸ºè¡Œæ•°ï¼‰
summary(gapminder$year) #è·å–å¹´ä»½çš„ä¸Šè¿°æ‰€æœ‰ä¿¡æ¯
class(gapminder$gdpPercap) #æŸ¥çœ‹å¹´ä»½ç»“æ„ï¼švectorã€matrixã€arrayã€dataframeã€list
typeof(gapminder$gdpPercap) #æŸ¥çœ‹å¹´ä»½å…ƒç´ ç±»å‹
```

## `Tidyverse`åŒ…

> èŒèŒï¼šæ¬¢è¿æ¥åˆ° `Tidyverse`ä¸–ç•Œï¼Œè®©æˆ‘ä»¬é€šè¿‡ä¸‹é¢è¿™å¼ å›¾ä¸€èµ·æ­å¼€`Tidyverse`çš„åºå±±çœŸé¢ç›®å§ï¼

```{r out.width = "60%", echo = FALSE}
knitr::include_graphics("images/tidyverseHive.png")
```

> èŒèŒï¼šå“ˆï¼çœ‹å®Œä¸Šé¢è¿™å¼ å›¾ï¼Œæ˜¯ä¸æ˜¯å¯¹`Tidyverse`åŒ…æœ‰äº†æ–°çš„äº†è§£ï¼Ÿæ­å–œä½ ï¼Œæˆ‘ä»¬çš„é—¯å…³ä¹‹æ—…åˆè¿‘äº†ä¸€æ­¥ï¼

+ ä¸€ä¸ªHadleyåŒ…
+ å®é™…ä¸Šæ˜¯ä¸€ä¸ªä¸æ–­å¢é•¿çš„ [æ•°æ®åŒ…](https://www.tidyverse.org/packages/)ï¼

+ å®‰è£…:

```{r loadTidy, exercise = TRUE}
## install.packages("tidyverse")
library("tidyverse")
```

> èŒèŒï¼šæ¥ä¸‹æ¥å°±è®©æˆ‘ä»¬ä¸€èµ·äº†è§£ä»Šå¤©æ•…äº‹çš„ä¸»è§’â€”â€”`dplyr`ã€‚

##  `dplyr`åŒ…

ä»–ä»¬åªåšä¸€ä»¶äº‹ï¼Œå´åšå¾—å¾ˆå¥½ã€‚

```{r out.width = "60%", echo = FALSE}
knitr::include_graphics("images/simple.png")
```

### å¯ç»„åˆæ€§ï¼š

```{r out.width = "60%", echo = FALSE}
knitr::include_graphics("images/composable.png")
```

> èŒèŒï¼šæƒ³å†™å‡ºæ›´åŠ ç®€æ´å’Œé…·ç‚«çš„ä»£ç å—ï¼Ÿé‚£å°±ä½¿ç”¨`dplyr`åŒ…å§ï¼å·å·å‘Šè¯‰ä½ å…³äº`%>%`çš„å¿«æ·é”®æ–¹å¼å“Ÿï¼Œè¿™æ˜¯å±äºæˆ‘ä¿©ä¹‹é—´çš„ç§˜å¯†ï¼Œå¯åˆ«å‘Šè¯‰åˆ«äººï¼Œå˜˜ğŸ¤«ï¼

 `%>%`çš„å¿«æ·é”®:

* Ctrl + Shift + M (Win)
* Cmd + Shift + M (Mac)

## æ•°æ®æ¦‚è§ˆ

### æ‹“å±•æå‡

> èŒèŒï¼šè¿˜è®°å¾—ä¸Šä¸€å…³å¡è·å–çš„ `str()`æŠ€èƒ½å—ï¼Ÿè®©æˆ‘ä»¬ä¸€èµ·å›å¿†ä¸€ä¸‹å§

```{r overview, exercise = TRUE}
str(gapminder)
glimpse(gapminder)
```

### æŒ‰åºæŸ¥çœ‹

> èŒèŒï¼šä½ èƒ½å‘Šè¯‰æˆ‘å“ªä¸ªå›½å®¶çš„äººå£æœ€å¤š&å“ªä¸ªå›½å®¶çš„äººå£æœ€å°‘å—ï¼Ÿ

```{r out.width = "60%", echo = FALSE}
knitr::include_graphics("images/arrange.png")
```

```{r out.width = "90%", echo = FALSE}
knitr::include_graphics("images/desc.png")
```

```{r ex_arrange, exercise = TRUE}
gapminder
```

```{r ex_arrange-solution}
gapminder %>%
  arrange(pop) # arrangeå‡½æ•°ç”¨äºæ’åºï¼Œæ­¤å¤„ä¸ºæŒ‰ç…§äººå£è§„æ¨¡ä»å°åˆ°å¤§è¿›è¡Œæ’åº

arrange(gapminder, desc(pop)) #æ­¤å¤„ä¸ºæŒ‰ç…§äººå£è§„æ¨¡è¿›è¡Œé™åºæ’åˆ—
```


> èŒèŒï¼šå‘€ï¼ä½ çœŸæ£’ï¼é‚£ä½ è¿˜èƒ½å‘Šè¯‰æˆ‘æ¯ä¸ªå¤§æ´²åˆ†åˆ«æœ‰å¤šå°‘ä¸ªè§‚æµ‹å€¼?&æ¯ä¸ªå¤§æ´²çš„è§‚æµ‹å€¼æ•°é‡ä¸€æ ·å—&æ¯ä¸ªå›½å®¶å‘¢ï¼Ÿ

```{r ex_count, exercise = TRUE}
gapminder %>%
  count(continent)

# gapminder %>%
#   add_count(continent)
```

```{r ex_count-solution}
gapminder %>%
  count(continent, country)
```

> èŒèŒï¼šè¯•ç€ä½¿ç”¨`count()`ï¼Œçœ‹çœ‹èƒ½è·å–ä»€ä¹ˆï¼Œå˜»å˜»ğŸ˜ 

### æ€»ç»“æ•°æ®

> èŒèŒï¼šæˆ‘æƒ³çŸ¥é“äººå‡å›½æ°‘ç”Ÿäº§æ€»å€¼å’Œé¢„æœŸå¯¿å‘½çš„ä¸­ä½æ•°åˆ†åˆ«æ˜¯ä»€ä¹ˆï¼Œä½ èƒ½è¯•ç€å‘Šè¯‰æˆ‘å—?

```{r out.width = "95%", echo = FALSE}
knitr::include_graphics("images/summarise.png")
```


```{r ex_summary, exercise = TRUE}
gapminder %>%
  summarise(mean_gdp = mean(gdpPercap), median_life = median(lifeExp))
```

### ç»„å†…æ€»ç»“

> èŒèŒï¼šä¸æ‡‚å°±é—®ï¼Œè¯·é—®*æ¯ä¸ªå¤§æ´²çš„*äººå‡å›½æ°‘ç”Ÿäº§æ€»å€¼å’Œé¢„æœŸå¯¿å‘½çš„ä¸­ä½æ•°åˆ†åˆ«æ˜¯ä»€ä¹ˆï¼Ÿ

```{r out.width = "95%", echo = FALSE}
knitr::include_graphics("images/group_by.png")
```

```{r ex_summaryG, exercise = TRUE}
gapminder %>%
  group_by(continent) %>%
  summarise(mean_gdp = mean(gdpPercap), median_life = median(lifeExp))
```

>èŒèŒï¼šæ­å–œä½ å°†æœ¬æ¬¡é—¯å…³ä¹‹æ—…çš„è¿›åº¦æ¡æ¨è¿›è‡³1/2ğŸ‰ğŸ‰ï¼ŒåŠ æ²¹ï¼Œç»ˆç‚¹æœ‰ä¸°åšçš„å¥–åŠ±å“ŸğŸï¼

## æ•°æ®æå–

### filterå‡½æ•°

>èŒèŒï¼šè¯•ç€çœ‹çœ‹*2007*å¹´å“ªä¸ªå›½å®¶çš„äººå£æ•°é‡æœ€å¤šå—?

```{r out.width = "95%", echo = FALSE}
knitr::include_graphics("images/filter.png")
```

```{r ex_filter, exercise = TRUE, exercise.eval = TRUE}
gapminder %>%
  arrange(desc(pop))
```

```{r ex_filter-solution}
gapminder %>%
  filter(year == 2007) %>% #filterå‡½æ•°ç­›é€‰å‡ºå¹´ä»½ä¸º2007å¹´
  arrange(desc(pop)) #å†æ ¹æ®äººå£è§„æ¨¡è¿›è¡Œé™åºæ’åˆ—
```

>èŒèŒï¼šå¦‚æœä½ å·²ç»çŸ¥é“äº†2007å¹´äººå£æœ€å¤šçš„å›½å®¶ï¼Œé‚£ä¹ˆ2007å¹´ä»¥å‰çš„åå¹´å“ªä¸ªå›½å®¶çš„äººå£æ•°é‡æœ€å¤šå‘¢? (æç¤º: æŠŠ `%in%` å½“æˆä¸€ä¸ªæ¡ä»¶ğŸ˜)

### selectå‡½æ•°

>èŒèŒï¼šæ¥ä¸‹æ¥çš„æŒ‘æˆ˜å°†ä¼šæ›´éš¾å“Ÿï¼ä½ èƒ½å‘Šè¯‰æˆ‘ï¼š

1. ä»…å›½å®¶ï¼Œå¹´ä»½å’Œäººå£
2. é™¤äº†å¤§æ´²çš„ä¸€åˆ‡
3. ä»¥"co"å¼€å¤´çš„å˜é‡

```{r out.width = "95%", echo = FALSE}
knitr::include_graphics("images/select.png")
```

```{r ex_select, exercise = TRUE}
gapminder %>%
  select(country, year, pop) #é€‰æ‹©å›½å®¶ã€å¹´ä»½ã€äººå£è§„æ¨¡
```

```{r ex_select-solution}
gapminder %>%
  select(-continent) #å»æ‰å¤§æ´²

gapminder %>%
  select(starts_with("co")) #åŒ¹é…ä»¥â€œcoâ€å¼€å¤´çš„åç§°
```

### filterä¸selectä¹‹åŒé‡æš´å‡»

>èŒèŒï¼š2007å¹´äººå£æœ€å¤šçš„å›½å®¶çš„é¢„æœŸå¯¿å‘½æ˜¯å¤šå°‘---è¯·åŒæ—¶æä¾›å›½å®¶åç§°, äººå£æ•°é‡, ä»¥åŠé¢„æœŸå¯¿å‘½?

```{r out.width = "95%", echo = FALSE}
knitr::include_graphics("images/comboAttack.gif")
```

```{r ex_combo, exercise = TRUE}
gapminder
```

```{r ex_combo-solution}
gapminder %>%
  filter(year == 2007) %>%
  arrange(desc(pop)) %>%
  select(country, pop, lifeExp)
```

### mutateå‡½æ•°

>èŒèŒ:æ¯ä¸ªå›½å®¶çš„å›½æ°‘ç”Ÿäº§æ€»å€¼æ˜¯å¤šå°‘?

```{r out.width = "95%", echo = FALSE}
knitr::include_graphics("images/mutate.png")
```

```{r ex_mutate, exercise = TRUE}
gapminder %>%
  mutate(gdp = pop * gdpPercap) %>% #å¯æ ¹æ®å·²æœ‰å˜é‡æ·»åŠ æ–°çš„å˜é‡ï¼Œå°†æ–°æ·»åŠ çš„åˆ—åˆ°å·²æœ‰åˆ—çš„æœ«å°¾
    select(country, pop, gdpPercap, gdp)
```

>èŒèŒ:æˆ‘æƒ³ä¿ç•™æ•°å€¼å‹å˜é‡ä¸­çš„æ•´æ•°ï¼Œè¯¥æ€ä¹ˆåšäº†ï¼Ÿ

```{r ex_batch, exercise = TRUE}
gapminder %>%
  mutate_if(is.double, round, digits = 0) #mutate_ifå¯¹æ•°æ®è¿›è¡Œåˆ¤æ–­ï¼Œå¦‚æœæ˜¯Tï¼Œåˆ™å¯¹å…¶è¿›è¡Œå››èˆäº”å…¥æ“ä½œ
```

### æ•²é»‘æ¿ï¼

å½“ä½¿ç”¨ `gapminder %>% ...`æŒ‡ä»¤çš„æ—¶å€™, ä½ <span style="color:red">æ²¡æœ‰</span>å¢åŠ æˆ–æ”¹å˜`gapminder`çš„ä»»ä½•ä¸œè¥¿.
å¦‚æœä½ æƒ³æŠŠå˜åŒ–ä¿å­˜ä¸‹æ¥, æŠŠç»“æœå‘ç»™ä¸€ä¸ªå¯¹è±¡ã€‚

```{r eval = FALSE}
gapminderNew <- gapminder %>% ...
```

## è¯¾åæ€è€ƒ

1. è¡ŒåŠ¨<span style="color:red">ä¹‹å‰</span> å¼„æ¸…æ¥šé€»è¾‘;
1. å·§å¦™åœ°ä½¿ç”¨ `dplyr` çš„åŠŸèƒ½å¹¶èä¼šè´¯é€š;
    + å½’çº³: `arrange`, `count`, `summarise`
    + æå–: `filter`, `select`, `mutate`
1. ä¸è¦å¿˜äº† `group_by` å’Œ `mutate_if`

## é¢å¤–å¥–åŠ±

```{r df_coalesce, echo = FALSE}
df_toy <- data.frame(x = sample(c(1:2, NA, NA, NA)),
                     y = c(1, 2, NA, NA, 5),
                     z = c(NA, NA, 3, 4, 5))
```

>èŒèŒ: æˆ‘æ€ä¹ˆæ ·æ‰èƒ½å¡«è¡¥ç¼ºå¤±çš„ `x`, ç„¶åæŠŠ `y` å’Œ `z` åˆå¹¶æˆä¸€ä¸ªå˜é‡å‘¢?

```{r coalesce, exercise = TRUE}
df_toy %>%
  mutate(x = coalesce(x, 0L),
         yz = coalesce(y, z))
```


## è°¢è°¢ï¼

<i class="fa fa-envelope fa-lg"></i>&nbsp; [yuehu@tsinghua.edu.cn](mailto:yuehu@tsinghua.edu.cn)

<i class="fa fa-globe fa-lg"></i>&nbsp; https://sammo3182.github.io/

<i class="fab fa-github fa-lg"></i>&nbsp; [sammo3182](https://github.com/sammo3182)
