---
title: "Dr. Hu's R Workshop"
output: 
  learnr::tutorial:
    progressive: true
    allow_skip: true
    css: "style_ui.css"
runtime: shiny_prerendered
---


```{r setup, include=FALSE}
library(learnr)
library(tidyverse)
library(gapminder)
```

# æ•°æ®æ•´ç†

## å¯¼è¨€

å¤§å®¶å¥½ï¼Œæˆ‘æ˜¯èŒèŒï¼æ¬¢è¿æ¥åˆ°â€œLearning R with Dr. Hu and His Friendsâ€!
ç°åœ¨æˆ‘ä»¬å°†å¼€å¯æˆä¸º`R expert`æ—…ç¨‹çš„ç¬¬äºŒç«™ï¼Œæ•°æ®æ•´ç†ã€‚
åœ¨æœ¬èŠ‚ä¸­èƒ¡è€å¸ˆå°†å¸¦é¢†å¤§å®¶äº†è§£æœ€é«˜æ•ˆçš„æ•°æ®æ¸…ç†å’Œè°ƒæ•´æŠ€æœ¯ï¼Œè¯·è®¤çœŸå­¦ä¹ å“Ÿï¼

## çŸ¥è¯†ç‚¹

æ•°æ®æ•´ç†ï¼š

+ æ¢ç´¢
+ å½’çº³
+ æå–
+ è°ƒæ•´

### æ¡ˆä¾‹æ•°æ®

ç”± [Hans Rosling çš„ TED æ¼”è®²](https://www.ted.com/talks/hans_rosling_shows_the_best_stats_you_ve_ever_seen?utm_campaign=tedspread--b&utm_medium=referral&utm_source=tedcomshare) æ™®åŠçš„äººå£æ•°æ®ã€‚

```{r toy, exercise = TRUE, exercise.eval = TRUE}
library(gapminder)
gapminder
```

## æ•°æ®æ¢ç´¢

æ•°æ®æ¢ç´¢æ—¨åœ¨å¯¹é™Œç”Ÿæ•°æ®çš„æ•°æ®æ„æˆã€ç»“æ„ã€å½¢å¼ã€å†…å®¹çš„åˆæ­¥äº†è§£ï¼Œæ˜¯æ•°æ®åˆ†æçš„ç¬¬ä¸€æ­¥ï¼Œä¹Ÿæ˜¯å…³é”®ä¸€æ­¥ã€‚
æˆ‘ä»¬å°†æ•°æ®æ¢ç´¢åˆ†æˆä¸‰éƒ¨ï¼Œç”¨ä¸‰ä¸ªåŠ¨è¯æ¥è¡¨ç¤ºï¼šç§ï¼Œæï¼Œé’»ã€‚

### ç§ï¼šäº†è§£æ•°æ®æ ·è²Œ


```{r glimpse, exercise = TRUE, exercise.eval = TRUE}
head(gapminder, n = 6) # æŸ¥çœ‹æ•°æ®æ¡†ä¸­çš„å‰6è¡Œ

tail(gapminder, n = 3) # åä¸‰è¡Œ
```

### æï¼šæ€»ç»“æ•°æ®ç»“æ„

* è§‚å¯Ÿæ•°æ®å¤§å°ï¼ˆå¤šå°‘è¡Œï¼Œå¤šå°‘åˆ—ï¼‰
* å˜é‡çš„åå­—åŠæ•°é‡
* æ•°æ®ç»“æ„æ€»è§ˆ

```{r systemView, exercise = TRUE}
gapminder
```

```{r systemView-solution}
nrow(gapminder) # è·å–æ•°æ®çš„è¡Œæ•°
ncol(gapminder) # è·å–æ•°æ®çš„åˆ—æ•°
names(gapminder) # è·å–å˜é‡å/åˆ—å
str(gapminder) # è·å–å˜é‡åã€å˜é‡åç±»å‹ã€è¡Œæ•°ã€åˆ—æ•°
```


### é’»ï¼šäº†è§£å˜é‡

æ¯”å¦‚äººå£å˜é‡, æˆ‘ä»¬å¯èƒ½æƒ³çŸ¥é“å›½å®¶äººå£çš„ä¸€èˆ¬æ°´å¹³æ˜¯å¤šå°‘ï¼Œå“ªä¸ªå›½å®¶çš„äººå£æœ€å¤šï¼æœ€å°‘, è¿˜æœ‰å…¶ä»–å†…å®¹ã€‚ 
ä»–ä»¬éƒ½è¢«å­˜æˆäº†ä»€ä¹ˆç±»ï¼Ÿ

> èŒèŒï¼šè¿˜è®°å¾—ç±»ä¸ï¼Ÿç±»æ˜¯æŒ‡å¯¹å¯¹è±¡å±æ€§ç»“æ„çš„è§„å®šã€‚

```{r variable, exercise = TRUE}
head(gapminder$year, n = 10) #æŸ¥çœ‹å¹´ä»½å‰10è¡Œ
```

```{r variable-solution}
mean(gapminder$year, na.rm = TRUE) #æ±‚å–å¹´ä»½çš„å¹³å‡å€¼ï¼Œna.rm = TRUEè¡¨ç¤ºå¿½ç•¥NA
median(gapminder$year) #æ±‚å–å¹´ä»½çš„ä¸­é—´å€¼
min(gapminder$year) #æ±‚å–å¹´ä»½çš„æœ€å°å€¼
max(gapminder$year) #æ±‚å–å¹´ä»½çš„æœ€å¤§å€¼
length(gapminder$year) #æ±‚å–å¹´ä»½çš„é•¿åº¦ï¼ˆæ­¤å¤„ä¸ºè¡Œæ•°ï¼‰
summary(gapminder$year) #è·å–å¹´ä»½çš„ä¸Šè¿°æ‰€æœ‰ä¿¡æ¯
class(gapminder$gdpPercap) #æŸ¥çœ‹å¹´ä»½ç»“æ„ï¼švectorã€matrixã€arrayã€dataframeã€list
typeof(gapminder$gdpPercap) #æŸ¥çœ‹å¹´ä»½å…ƒç´ ç±»å‹
```

## æ•°æ®å½’çº³

æ•°æ®å½’çº³æ˜¯å¯¹æ•°æ®ç‰¹å¾çš„æŒ–æ˜å’Œæ•´ç†ã€‚
æˆ‘ä»¬å°†ä½¿ç”¨`tidyverse`ç³»åˆ—å‡½æ•°æ¥å®ç°é«˜æ•ˆæ•°æ®å½’çº³ã€‚

### ä»€ä¹ˆæ˜¯`tidyverse`

+ æ˜¯ä¸€ä¸ªRåŒ…
+ å…¶å®æ˜¯ä¸€ç¾¤[RåŒ…](https://www.tidyverse.org/packages/)ï¼
+ åƒæ¼«å¨å’ŒDCæ¼«ç”»å®‡å®™ä¸€æ ·ï¼Œæ‰€æœ‰`tidyverse`ç»„æˆæˆå‘˜éƒ½åœ¨åŒä¸€ä¸ªæ•°æ®ç»“æ„å†…å·¥ä½œï¼Œå¯ä»¥ç›¸äº’å¯¹è¯ï¼Œå…±åŒä½¿ç”¨ã€‚

### `tidyverse`ç»„æˆ

```{r out.width = "100%", echo = FALSE}
knitr::include_graphics("images/tidyverseHive.png")
```

###

+ å®‰è£…:

```{r loadTidy, exercise = TRUE}
## install.packages("tidyverse")
library("tidyverse")
```

> èŒèŒï¼š`tidyverse`ä¸­æ•°æ®åŒ…å„æœ‰ç‹¬ç‰¹åŠŸç”¨ï¼Œæˆ‘ä»¬ä¹‹åå°†é¢‘ç¹å’Œå®ƒä»¬æ‰“äº¤é“ã€‚

### `dplyr`åŒ…

`tidyverse`ä¸­ä¸“é—¨è´Ÿè´£æ•°æ®æ¸…ç†çš„ç»„ä»¶ï¼Œè´¯å½»ä¸€ä¸ªå‡½æ•°åšä¸€ä»¶äº‹çš„é£æ ¼ã€‚

+ ä¸“é—¨æ€§

```{r out.width = "80%", echo = FALSE}
knitr::include_graphics("images/simple.png")
```

> èŒèŒï¼š`dplyr`æ˜¯å¯¹æ•°æ®æ•´ç†çš„ä¼Ÿå¤§å‘æ˜ï¼Œæˆ‘è§‰å¾—å®ƒæœ€å‰å®³çš„åœ°æ–¹æ˜¯è®©è®¡ç®—æœºåœ¨æ•°æ®æ•´ç†çš„æ—¶å€™èƒ½â€œè¯´äººè¯â€ğŸ˜˜

+ ç»„åˆæ€§

```{r out.width = "80%", echo = FALSE}
knitr::include_graphics("images/composable.png")
```

`%>%`çš„å¿«æ·é”®:

* Ctrl + Shift + M (Win)
* Cmd + Shift + M (Mac)

### `arrange`

```{r out.width = "60%", echo = FALSE}
knitr::include_graphics("images/arrange.png")
```

```{r out.width = "90%", echo = FALSE}
knitr::include_graphics("images/desc.png")
```

###

å°†æ•°æ®æ ¹æ®äººå£ç”±å°‘åˆ°å¤šï¼ˆæˆ–è€…æœ‰å¤šåˆ°å°‘ï¼‰æ’åˆ—ï¼Ÿ

```{r ex_arrange, exercise = TRUE}
gapminder
```

```{r ex_arrange-solution}
gapminder %>%
  arrange(pop) # arrangeå‡½æ•°ç”¨äºæ’åºï¼Œæ­¤å¤„ä¸ºæŒ‰ç…§äººå£è§„æ¨¡ä»å°åˆ°å¤§è¿›è¡Œæ’åº

arrange(gapminder, desc(pop)) #æ­¤å¤„ä¸ºæŒ‰ç…§äººå£è§„æ¨¡è¿›è¡Œé™åºæ’åˆ—
```

### `count`

æ•°æ®ä¸­å¯¹äºæ¯ä¸ªå¤§æ´²å„æœ‰å¤šå°‘ä¸ªè§‚æµ‹å€¼ï¼Ÿæ¯ä¸ªå›½å®¶å„æœ‰å¤šå°‘ä¸ªï¼ˆè¯·æŒ‰å¤§æ´²æ’åˆ—ï¼‰ï¼Ÿ

```{r ex_count, exercise = TRUE}
gapminder %>%
  count(continent)

# gapminder %>%
#   add_count(continent) # adding the count number to the dataset.
```

```{r ex_count-solution}
gapminder %>%
  count(continent, country)
```


### `summary`

```{r out.width = "95%", echo = FALSE}
knitr::include_graphics("images/summarise.png")
```

###

äººå‡å›½æ°‘ç”Ÿäº§æ€»å€¼å’Œé¢„æœŸå¯¿å‘½çš„ä¸­ä½æ•°åˆ†åˆ«æ˜¯ä»€ä¹ˆ?

```{r ex_summary, exercise = TRUE}
gapminder %>%
  summarise(mean_gdp = mean(gdpPercap), median_life = median(lifeExp))
```

### `group_by`

```{r out.width = "95%", echo = FALSE}
knitr::include_graphics("images/group_by.png")
```

###

*æ¯ä¸ªå¤§æ´²çš„*äººå‡å›½æ°‘ç”Ÿäº§æ€»å€¼å’Œé¢„æœŸå¯¿å‘½çš„ä¸­ä½æ•°åˆ†åˆ«æ˜¯å¤šå°‘ï¼Ÿ

```{r ex_summaryG, exercise = TRUE}
gapminder %>%
  group_by(continent) %>%
  summarise(mean_gdp = mean(gdpPercap), median_life = median(lifeExp))
```

## æ•°æ®æå–

`dplyr`ä¸­ä¹Ÿèƒ½å¸®åŠ©æˆ‘ä»¬å®ç°æ•°æ®æå–ï¼Œä¸»è¦é€šè¿‡`filter`å’Œ`select`å®ç°ã€‚

### `filter`

```{r out.width = "95%", echo = FALSE}
knitr::include_graphics("images/filter.png")
```

###

å¦‚ä½•çŸ¥é“*2007*å¹´å“ªä¸ªå›½å®¶çš„äººå£æ•°é‡æœ€å¤šï¼Ÿ

```{r ex_filter, exercise = TRUE, exercise.eval = TRUE}
gapminder %>%
  arrange(desc(pop))
```

```{r ex_filter-solution}
gapminder %>%
  filter(year == 2007) %>% #filterå‡½æ•°ç­›é€‰å‡ºå¹´ä»½ä¸º2007å¹´
  arrange(desc(pop)) #å†æ ¹æ®äººå£è§„æ¨¡è¿›è¡Œé™åºæ’åˆ—
```

### `select`

```{r out.width = "95%", echo = FALSE}
knitr::include_graphics("images/select.png")
```

1. æå–å›½å®¶ï¼Œå¹´ä»½å’Œäººå£
2. é™¤äº†å¤§æ´²çš„ä¸€åˆ‡
3. ä»¥"co"å¼€å¤´çš„å˜é‡

###

```{r ex_select, exercise = TRUE}
gapminder %>%
  select(country, year, pop) #é€‰æ‹©å›½å®¶ã€å¹´ä»½ã€äººå£è§„æ¨¡
```

```{r ex_select-solution}
gapminder %>%
  select(-continent) #å»æ‰å¤§æ´²

gapminder %>%
  select(starts_with("co")) #åŒ¹é…ä»¥â€œcoâ€å¼€å¤´çš„åç§°
```

> èŒèŒï¼šæœ‰äº›åŒå­¦å¾ˆå®¹æ˜“å°†`filter`å’Œ`select`ææ··ï¼Œç»™å¤§å®¶ä¸€ä¸ªå°å£è¯€â€œselectæŒ‘åˆ—ï¼Œfilteré€‰è¡Œâ€ã€‚

### æŒ‘æˆ˜æ—¶é—´ï¼Ÿ

æƒ³è¦ä»è·¨å¹´æ•°æ®ä¸­æå–2007å¹´çš„å›½å®¶æå…¶äººå£æ•°é‡å’Œé¢„æœŸå¯¿å‘½ï¼Œåº”è¯¥æ€ä¹ˆåšï¼Ÿ

> èŒèŒï¼šå°æç¤ºâ€”â€”being Bruce Lee!

```{r out.width = "80%", echo = FALSE}
knitr::include_graphics("images/comboAttack.gif")
```

###

```{r ex_combo, exercise = TRUE}
gapminder
```

```{r ex_combo-solution}
gapminder %>%
  filter(year == 2007) %>%
  arrange(desc(pop)) %>%
  select(country, pop, lifeExp)
```

## æ•°æ®è°ƒæ•´

åœ¨æ•°æ®åˆ†æä¸­ï¼Œæˆ‘ä»¬å¸¸å¸¸è¦å°†æ•°æ®è¿›è¡Œè°ƒæ•´å’Œå†åŠ å·¥ï¼Œ`mutate`å¯ä»¥å¸®ä½ åšåˆ°è¿™ä¸€ç‚¹ã€‚
è‹±æ–‡ä¸­â€œmutateâ€è¡¨ç¤ºâ€œå˜å¼‚â€ï¼Œä¹Ÿå°±æ˜¯è¯´è¿™ä¸ªå‡½æ•°å¯ä»¥å®ç°çš„å¹¶ä¸æ˜¯æ— ä¸­ç”Ÿæœ‰ï¼Œè€Œæ˜¯æ”¹å¤´æ¢é¢ã€‚


> èŒèŒï¼šâ€œæ­£ç»â€çš„çŸ¥è¯†ï¼šå‰å‡ å¹´å¤§ç«çš„â€œé‡‘åˆšç‹¼â€ã€â€œXæˆ˜è­¦â€ã€â€œé»‘å‡¤å‡°â€ éƒ½åœ¨æç»˜ä¸€ç¾¤èº«ä½“å˜å¼‚çš„è¶…çº§è‹±é›„æ•…äº‹ã€‚è¿™ç¾¤è‹±é›„æœ‰ä¸ªç»Ÿä¸€çš„â€œç±»â€å«â€œå˜ç§äººâ€ï¼Œè‹±æ–‡å°±æ˜¯â€œmutantsâ€ï¼Œæ˜¯`mutate`å‡½æ•°éå¸¸å½¢è±¡çš„è¯ é‡Šã€‚

### `mutate`

```{r out.width = "95%", echo = FALSE}
knitr::include_graphics("images/mutate.png")
```

###

çŸ¥é“äº†äººå£å’Œäººå‡ç”Ÿäº§æ€»å€¼ï¼Œå¦‚ä½•çŸ¥é“å›½æ°‘ç”Ÿäº§æ€»å€¼?

```{r ex_mutate, exercise = TRUE}
gapminder %>%
  mutate(gdp = pop * gdpPercap) %>% #å¯æ ¹æ®å·²æœ‰å˜é‡æ·»åŠ æ–°çš„å˜é‡ï¼Œå°†æ–°æ·»åŠ çš„åˆ—åˆ°å·²æœ‰åˆ—çš„æœ«å°¾
    select(country, pop, gdpPercap, gdp)
```

### æ¡ä»¶æ€§æ”¹å˜

å¦‚ä½•å¯¹å˜é‡è¿›è¡Œæ‰¹é‡ä¿®æ”¹ï¼Ÿ`dplyr`å’Œå®ƒçš„æœ‹å‹`tidyselect`æä¾›äº†`across`å’Œ`where`å‡½æ•°ã€‚
è®©æˆ‘ä»¬çœ‹çœ‹å¦‚ä½•é€šè¿‡è¿™äº›å‡½æ•°å®ç°å°†æ•°æ®ä¸­æ‰€æœ‰çš„éæ•´æ•°å˜é‡éƒ½å››èˆäº”å…¥å–æ•´ï¼Ÿ

```{r ex_batch, exercise = TRUE}
gapminder %>%
  mutate(across(where(is.double), round, digits = 0))
```

> èŒèŒï¼š`across`å’Œ`where`åœ¨å¾ˆå¤š`dplyr`å‡½æ•°ä¸­éƒ½èƒ½ä½¿ç”¨ï¼Œæ¯”å¦‚`arrange`ã€`filter`ã€`summarise`ç­‰ã€‚è€Œæœ‰çš„`dplyr`å‡½æ•°è¿˜æœ‰è‡ªå·±ç‹¬æœ‰çš„æ¡ä»¶ç­›é€‰å‘½ä»¤ï¼Œæ¯”å¦‚å’Œ`select`é…å¥—çš„å°±æœ‰`starts_with`ã€`ends_with`ã€`contains`ã€`matches`ç­‰ç­‰ã€‚å¥½å­¦å¦‚ä½ ï¼Œè¯·å»å°½æƒ…æŒ–æ˜å§ï¼

### æ ¹æœ¬åŸåˆ™

åŸºäº`tidyverse`çš„æ•°æ®æ•´ç†ï¼Œæœ‰ä¸€ä¸ªé‡è¦çš„æ ¸å¿ƒå‰æï¼šâ€œä¸æ”¹å˜åŸå§‹æ•°æ®â€â€”â€”è¿™ä¹Ÿæ˜¯æ‰€æœ‰æ•°æ®åˆ†æè€…éƒ½åº”éµå®ˆçš„åŸåˆ™ã€‚
ä½ ä¼šå‘ç°æ— è®ºä½ ä½¿ç”¨ä»¥ä¸Šå‘½ä»¤å¯¹åŸæ•°æ®åšäº†ä»€ä¹ˆ, ä½ å®é™…éƒ½<span style="color:red">æ²¡æœ‰</span>å¢åŠ æˆ–æ”¹å˜`gapminder`çš„ä»»ä½•ä¸œè¥¿ã€‚

å¦‚æœä½ æƒ³æŠŠå˜åŒ–ä¿å­˜ä¸‹æ¥, ä½ è¦æŠŠç»“æœèµ‹å€¼ç»™ä¸€ä¸ªæ–°çš„å¯¹è±¡ï¼Œè€Œä¿æŒä½ åŸæ¥æ•°æ®çš„å®Œæ•´æ€§ã€‚

```{r eval = FALSE}
gapminderNew <- gapminder %>% ...
```

## æ€»ç»“

1. è¡ŒåŠ¨<span style="color:red">ä¹‹å‰</span> æƒ³æ¸…æ¥š;
1. å·§å¦™ä¸”ç»¼åˆåœ°ä½¿ç”¨ `dplyr` å‡½æ•°;
    + æ¢ç´¢: `glimpse`
    + å½’çº³: `arrange`, `count`, `summarise`
    + æå–: `filter`, `select`
    + è°ƒæ•´: `mutate`
1. æ¡ä»¶æ€§æ“ä½œ
    + `group_by`
    + `across` & `where`
    + `starts_with`, etc.

## Bonus

```{r df_coalesce, echo = FALSE}
df_toy <- data.frame(x = sample(c(1:2, NA, NA, NA)),
                     y = c(1, 2, NA, NA, 5),
                     z = c(NA, NA, 3, 4, 5))

df_toy
```

###

æ€ä¹ˆæ ·æ‰èƒ½å¡«è¡¥ç¼ºå¤±çš„ `x`, ç„¶åæŠŠ `y` å’Œ `z` åˆå¹¶æˆä¸€ä¸ªå˜é‡å‘¢?

```{r coalesce, exercise = TRUE}
df_toy %>%
  mutate(x = coalesce(x, 0L),
         yz = coalesce(y, z))
```


### æ„Ÿè°¢è†å¬ï¼Œä¸‹æ¬¡å†è§ï¼

<i class="fa fa-envelope fa-lg"></i>&nbsp; [yuehu@tsinghua.edu.cn](mailto:yuehu@tsinghua.edu.cn)

<i class="fa fa-globe fa-lg"></i>&nbsp; https://sammo3182.github.io/

<i class="fab fa-github fa-lg"></i>&nbsp; [sammo3182](https://github.com/sammo3182)
