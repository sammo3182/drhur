---
title: "数据描述"
subtitle: "Learning R with Dr. Hu and His Friends"
author: "胡悦（清华大学政治学系）"
output: 
  learnr::tutorial:
    language: "zh"
    progressive: true
    allow_skip: true
runtime: shiny_prerendered
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE,
                      message = FALSE,
                      warning = FALSE,
                      out.width="100%")

if (!require(pacman)) install.packages("pacman")

p_load(drhur,
       here,
       rio,
       tidyverse,
       modelsummary)

```


## 知识点

- 变量描述
    - 原始数据
    - 矩

- 数据描述
    - 数据框
    - 数据信息

- 可视化
    - 表
    - 图

## 演示数据

我们在这部分继续使用WVS7的一个样本进行演示。
具体变量信息可通过`?drhur::wvs7`查看。

```{r wvs7}
library(drhur)
data("wvs7")
```


## 变量描述
### 原始数据

很多研究者喜欢看更为原始的数据。
在这里我们介绍两种直接看数据的方法：

第一，直接输入数据名称

```{r seeRaw1}
wvs7$age
```

第二，`head/tail`

```{r seeRaw2}
head(wvs7$age)
```

第三，`select`

```{r seeRaw3}
library(dplyr)

select(wvs7, age, female)
```

更多时候，变量的矩和其他统计能给我们提供更提纲挈领、简明扼要的信息。
我们在上一章给大家介绍了`table`。
这里做两个扩展：

- `table`还可以显示缺失数据信息：

```{r tableMissing}
table(wvs7$age, useNA = "ifany")
```

- 对于`table`的“表头”，可以使用`unique`一并提取:

```{r unique}
unique(wvs7$age)
```


### 矩

在上一课我们介绍可以使用`summary`获得变量特征信息。
但很多时候出于需要，有必要对其中的统计量单独计算，比如在政治学和社会学实验中我们常要比较实验组和控制组的分布差别来判断实验干预是否有效。
这种情况下就需要将平均值、中位数等等单独提取比较。

我们下面基于WVS7的年龄变量来演示如何进行这些操作：

```{r summary, exercise=TRUE}
summary(wvs7$age)
```

```{r summary-solution}
min(wvs7$age) 
quantile(wvs7$age, 1/4, na.rm = TRUE)
median(wvs7$age)
mean(wvs7$age, na.rm = TRUE)
quantile(wvs7$age, 3/4, na.rm = TRUE)
max(wvs7$age) 
sum(is.na(wvs7$age))

IQR(wvs7$age, na.rm = TRUE) # quantile(x, 3/4) - quantile(x, 1/4)
```

> 提示：`na.rm` 是指如何对待缺失变量，通常是逻辑值，取`TRUE`表示命令运行前去除缺失变量。

###

作为以统计计算为根本使命的编程语言，R（尤其是`moments`软件包)还提供了非常便捷的途径运算除平均值以外的变量分布的矩：

```{r moments, exercise=TRUE}
## Variance

## Standard deviation

## Skewness

## Kurtosis
```

```{r moments-solution}
## Variance
var(wvs7$age, na.rm = TRUE)

## Standard deviation
sd(wvs7$age, na.rm = TRUE)

## Skewness
library(moments)
skewness(wvs7$age, na.rm = TRUE)

## Kurtosis
kurtosis(wvs7$age, na.rm = TRUE)
```


## 数据描述
### 数据框

其实我们在上一课的“数据探索”中已经介绍了一些数据框描述的方法。
此处，我们做一些补充。

首先，对于一个数据，我们当然可以像对待变量一样，直接看它的原始数据样貌。
但如果数据过大，直接在操作台（console）中看可能非常麻烦，而且有可能因为R显示预设使我们无法看到想看到的变量。
那怎么办呢？
`View`命令给我们提供了一个方法，它会打开一个单独的窗口将数据全部显示出来。^[这里做个提醒：`View`命令的首字母是大写的，这点非常重要。
在R中`X`和`x`代表完全不同的对象或命令。]

```{r view, eval=FALSE}
View(wvs7)
```

其次，这种“直接看”的观察方法，对于拥有几百个变量、成千上万观测值的复杂数据而言可能并不十分高效。
更方便快捷的方法可能是截取数据的一部分来看一看：

```{r headTail, exercise=TRUE}

```

```{r headTail-solution}
head(wvs7, n = 6)
tail(wvs7, n = 7)
```

### 数据信息

`dplyr::glimpse`包为我们提供了另一种更加总结式的观测数据的方式：

```{r glimpse-hint}
library(dplyr)

glimpse(wvs7)
```

而如果我们想对数据进行更加规范性的描述，其实还可以使用`summary`对数据包含变量进行批处理：

```{r summaryData}
summary(wvs7)
```

但如上例所示，这种方法对像`country`这种字符变量不是特别友好，而且对于需要显示的统计值也缺乏灵活性。
下面我们从可视化角度探讨一下解决这个问题的一些方法。

## 可视化
### 表

<!-- 宇飞，请将datasummary vignette中各种操作添加进来 -->
<!-- https://vincentarelbundock.github.io/modelsummary/articles/datasummary.html -->

描述性统计图表是检验数据清理效果的利器，也是进行科学研究的规定动作。
表格中包含与研究相关的所有数据的分布信息。
传统的描述性表格制作通常是先是通过`summary`之类类似的命令在数据操作台上显示描述统计信息，然后手动制成以变量为行、统计信息种类为列的表格。
R语言研究生态的发展，为制作描述统计表格提供了前所未有的便利。

我们这里介绍使用`modelsummary`包制造描述性表格的方法。
`modelsummary`中`datasummary_skim`可以实现一行代码完成表格制作的神奇操作：

```{r dataSummary-skim, exercise = TRUE}
library("modelsummary")

datasummary_skim(wvs7)
datasummary_skim(wvs7, type = "categorical")
```

`datasummary_skim`的兄弟命令`datasummary`则可以帮助实现更加定制化的操作，比如不显示中位数而只显示平均值，或者使用方差代替标准差等等。
定制化语法为：

> `变量` + `变量`... ~ `统计值1` + `统计值2`...

```{r datasummary, exercise=TRUE}
datasummary(age + education ~ Mean + Var + P25 + P75, data = wvs7)

# 如果想对所有变量都执行以上操作怎么办？
```

```{r datasummary-solution}
datasummary(All(as.data.frame(wvs7)) ~ Mean + Var + P25 + P75, data = wvs7)
```

目前`modelsummary`支持十二种输出类型和七种输出格式，可以满足各种制表环境。
比如要生成MS Word文件，使用者只需规定输出文件后缀即可：

```{r datasummaryOut, eval=FALSE}
datasummary_skim(wvs7, output = "descriptiveTable.docx")
```

### 图

对于数据分布的图形化展示，我们这里推荐五种：

- 直方图
- 密度图
- 箱图
- 里克特图

由于大部分图形都是基于`ggplot2`制作的，我们需要对`ggplot2`制图的基本原理了解的基础上才能更好地掌握，因此对于图形的制作过程我们将留在下一节集中介绍，这里只是先展示一下图形制作完成后的效果，以及理解方法。

直方图是展示变量分布最直接的形式。

- 横轴：变量包含的特殊值
- 纵轴：每个特殊值出现的频率

```{r histogram, echo=FALSE}

ggplot(data = wvs7, aes(age)) +
  geom_histogram() + 
  theme_minimal()
```

在R中，我们也可以很容易地将多个变量直方图放在一个面板中展示。
比起分布表格，我认为这是更好展现变量分布特征的方式（除非选择`datasummary_skim`这种图加表的方式）。

```{r histPanel, echo=FALSE}
select(wvs7, 2:7) %>% 
  mutate(across(everything(), as.integer)) %>% 
  pivot_longer(cols = everything(), names_to = "variable") %>% 
  ggplot(aes(value)) +
  facet_wrap(~variable, scales = 'free') +
  geom_histogram()
```


密度图是直方图通过Kernel smoothing处理之后的结果。
比起直方图，它在细节上有所损失，但能更好地体现分布特征和总体趋势。

- 横轴：基于变量的连续数据
- 纵轴：Kernel密度

```{r density, echo=FALSE}
ggplot(data = wvs7, aes(age)) +
  geom_density() + 
  theme_minimal()
```

箱图可能是最常见的数据分布可视化方式。
图中，箱子的左沿是25%分位(Q1)，右沿是75%分位（Q3），中间竖线是中位数。
因此箱子整体表现的就是IQR范围。
贯穿箱子的线段和点标注的是分布的极值：最左端为最小值区间（Q1 - 1.5IQR），最右端为最大值区间（Q3 + 1.5IQR）。
之外的点为潜在的异常值（outliers）, 比如wvs7年龄数据中的94和99岁，都与其他值的值间距要大。


```{r box, echo=FALSE}
ggplot(data = wvs7, aes(age)) +
  geom_boxplot() + 
  theme_minimal()
```

最后，里克特图是专门展现里克特问题分布的可视化方式，在实验结果比较、调查问题分析等方面都有非常直观的表现力。

```{r likert, echo=FALSE}
library(sjPlot)

df_corrupt <- select(wvs7, starts_with("corruption"))
plot_likert(df_corrupt)
```

## 总结

<!-- 宇飞，请将上面用到的相关命令填入下面对应位置，可参考之前章节 -->

- 变量描述
    - 原始数据
    - 矩

- 数据描述
    - 数据框
    - 数据信息

- 可视化
    - 表
    - 图
