# Learn R with Dr.Hu and His Friends
# Sun Zhaoyang R lecture No.3 2021.10.21
# Basic Visualization with ggplot2

### 基于ggplot2的数据可视化基础

ggplot2是R语言常用的数据可视化分析包，不少构图精美的数据可视化分析都是运用ggplpt2制作而成的。在本节中，我们一起学习一下ggplot2的使用方法吧！接下来，我们会向你展示一些ggplot2常用的基础操作。

##基础设置
正式开始前，我们要为ggplot的良好运行配置环境。首先，我们要把当前源文件目录设置为工作目录，这能够让Rstudio运行时知道应该要从哪个文件夹里调用本章节所需要的文件。代码演示如下：
```{r}
setwd(dirname(rstudioapi::getActiveDocumentContext()$path))
```
当然，你需要提前安装和打开rstudioapi包。

或者，你你也可以通过setwd函数来设置工作目录，例如：setwd("D://xxx//xxx")。

同时，请确认你已经安装ggplot2、readxl、gridExtra3个包。
ggplot2是今天的主角，数据可视化的实现主要基于此包进行。
readxl能够实现读取Excel数据的功能，本节所使用的数据将来源于Excel格式的数据。
gridExtra则能够帮助解决图表的布局问题。
关于以上三个包的具体功能和实现方法我们稍后再展开讨论。如果你已经安装好它们，那就都打开吧！
```{r}
library(ggplot2) 
library(readxl) 
library(gridExtra) 
```
我们轻轻松松完成开展今天学习的环境配置了，真棒！
接下来，咱们正式进入今天的数据可视化分析学习！

#输入数据

首先，我们读取今天所使用的案例数据。让我们把WVS_CHN.xlsx输入R，并将其命名为data：
```{r}
data<- read_excel("WVS_CHN.xlsx", sheet="Sheet1")
View(data)
```

接下来，我们主要提取5个变量中的数据，为下一步做好准备。

我们提取编号为46的问答调查数据，该问题如下：
Q46 Taking all things together, would you say you are（总体而言，您认为自己）
 1 Very happy（十分幸福）
 2 Rather happy（比较幸福）
 3 Not very happy（不怎么幸福）
 4 Not at all happy（不幸福）
 
我们将这一组数据命名为Q46，并用table函数显示出来。
此时，你可能会发现有些数据并不完全符合你想要的格式，因此有必要用ifelse函数做一些处理。ifelse(Q46 < 0, NA, 5-Q46)意味着“如果值小于1，则记为‘NA（缺失）”；如果不是此类情况，则以5减去原值”。
按照如下代码，就可以实现这一功能啦！
```{r}
Q46 <- data$Q46
table(Q46)
recent_life_satisfaction <- ifelse(Q46 < 0, NA, 5-Q46) 
table(recent_life_satisfaction)
```
经过这次调整，我们将Q46数据命名为recent_life_satisfaction，数值1～4显示从不开心到十分开心的程度。

类似地，我们可以对Q49、Q50、Q260、Region等数据做类似的处理：

Q49 All things considered, how satisfied are you with your life as a whole these days? （总体而言，您对近期的生活有多满意？）
1 - 10表示：从Completely dissatisfied（十分满意）到Completely satisfied（完全不满意）
代码演示：
```{r}
Q49 <- data$Q49
table(Q49)
recent_life_satisfaction <- ifelse(Q49 < 0, NA, Q49)
table(recent_ife_satisfaction)
```

Q50 How satisfied are you with the financial situation of your household?（您对家庭的财务状况有多满意？）
1 - 10表示：从Completely dissatisfied（完全满意）到Completely satisfied（完全不满意）
代码演示：
```{r}
Q50 <- data$Q50
table(Q50)
househould_financial_satisfactiion <- ifelse(Q50 < 0, NA, Q50)
table(househould_financial_satisfactiion)
```

Q260 Respondent's Sex（受访者性别）
此处，我们分别用1和0分别代表男性、女性。
代码演示：
```{r}
Q260 <- data$Q260
table(Q260)
male <- ifelse(Q260==1,1,0)
table(male)
```

region province（所在地区省份）
在该向量中，不同的值各代表着特定区域，数据之间不存在可供比较或者计算的功能。因此，我们将其命名和输入即可。
代码演示：
```{r}
region <- data$N_REGION_ISO
```

#####################################################################
##---可视化美学：ggplot2的基础应用----------
#####################################################################
要在R中实现数据可视化有十分丰富的形式，例如grid、lattice、ggplot2等包都能以不同的形式生成图表。其中，ggplot2功能强大，能够支撑有创新性的绘图需求，是得到广泛应用的数据可视化主流工具。当然，灵活的作图也使得ggplot2拥有较为丰富的语法。在接下来的部分，我们将一起学习如何使用ggplot2的基础语法来生成一些较为精美的数据可视化图形。

# 选取数据
ggplot函数用于选择和初始化图形。例如，我们要将名称为data的数据导入，则可以用如下代码实现：
```{r}
ggplot(data = data)
```

# 图形设置
我们继续拓展其他的图形视觉选项。在ggplot函数中，aes是aesthetics的缩写，顾名思义，这是视觉呈现形式的选项。以recent_life_satifaction为例，可以通过如下代码生成一个直方图：
```{r}
ggplot(data = data, aes(x = recent_life_satisfaction)) +
  geom_histogram()
```
其中，data选项表示数据来源，aes函数中的x表示作为x轴的变量，geom_histogram函数表示直方图。换而言之，我们可以将以上代码翻译为“通过ggplot2，以data为数据源，将recent_life_satisfaction设置为x轴绘制直方图。”

# 色彩设置
不想再看到黑白的图形？那就继续拓展geom_histogram函数吧！例如，我们可以把以上数据做成一张灰色填充、红色边界、分为10组的直方图：
```{r}
ggplot(data = data, aes(x = recent_life_satisfaction)) +
  geom_histogram(fill = 'grey', color = 'red', bins = 10)
```
其中，fill表示填充区域的颜色（例如直方图中的条块），color表示填充区域边缘（或者线、点）的颜色，bins表示直方图中的组数。注意，此处的颜色直接以文本代指，为了让R辨认出你想要的颜色，一定记得打引号！


# 标题设置
为了让读者知道这幅图是干什么的，取一个一目了然的标题必不可少。ggtitle函数会帮你做到：
```{r}
ggplot(data = data, aes(x = recent_life_satisfaction)) +
  geom_histogram(fill = 'grey', color = 'black', bins = 10) +
  ggtitle('recent_life_satisfaction of Respondents')
```
R读不懂你的标题是什么意思，只会原模原样把标题挂在你想要的位置，因此记得给标题文本打引号。

## 注释设置
为了方便他人更好地读取图内信息，你可以使用lab、theme函数来丰富对图表的说明。例如，你想让别人知道x轴代表Recent Life Satisfaction，不对y轴做特别说明，那你可以：
```{r}
ggplot(data = data, aes(x = recent_life_satisfaction)) +
  geom_histogram(fill = 'grey', color = 'black', bins = 10) +
  ggtitle('recent_life_satisfaction of Respondents') +
  ylab('') +
  xlab('Recent Life Satisfaction') +
  theme(plot.title = element_text(hjust = 0.5))
```

# 主题设置
在这里，我们还尝试运用theme函数来设置主题：
```{r}
ggplot(data = data, aes(x = recent_life_satisfaction)) +
  geom_histogram(fill = 'grey', color = 'black',bins = 10) +
  ggtitle('recent_life_satisfaction of Respondents') +
  ylab('Density') +
  xlab('Gender') +
  theme_bw()+ # add theme here
  theme(plot.title = element_text(hjust = 0.5))
```
theme函数有一系列的细分功能，是一个成员丰富的“家族”。如果能够用好theme函数，可以帮助你更省事儿地实现不同图形的风格统一。在这里，theme_bw()表示将设置为黑白网格主题（ggplot2自带多种主题，其他主题也可以尝试一下～）。在theme函数中，plot.title表示标题外观，element_text(hjust = 0.5)表示将标题位置放在自左到右的0.5的位置，也就是居中。我们可以“举一反二”地猜出，如果hjust = 0，那就是向左适应，如果hjust = 1，那就是向右适应。

# 如何学习更多的ggplot2语法？
每个包都有附带手册，ggplot2也如此。我们已经一起学习了一小部分ggplot2的使用方法，但距离完全学会各项技能还有距离。因此，请通过ggplot2自带的help手册来按照自己的需求点亮对应的技能点吧！打开help手册可以在Rstudio界面用鼠标操作，我们也推荐用代码来打开：
```{r}
?ggplot()
```

## 储存图形
当我们已经精心制作好一个图形：
```{r}
fig1 <- ggplot(data = data, aes(x = recent_life_satisfaction)) +
  geom_histogram(fill = 'grey', color = 'black',bins = 10) +
  ggtitle('recent_life_satisfaction of Respondents') +
  ylab('Density') +
  xlab('Gender') +
  theme_bw()+ # add theme here
  theme(plot.title = element_text(hjust = 0.5))
fig1
```
我们就能通过ggsave函数将其储存：
```{r}
ggsave("myfirstplot.pdf", fig1) 
```
基础语法为ggsave("文件名称.文件格式", 图形名称)。例如，我们在代码中将文件名称命名为myfirstplot.pdf，格式为pdf，要储存的图形是fig1。在使用ggsave前记得给需要储存的图形命名，好让该函数理解你想要保存的图形是哪一个。

好啦！你现在可以在ggplot2中逐步尝试、大展身手啦！

## 图形布局
我们在一份图表中会遇到同时展示多个图形的需求，这时可以使用gridExtra来布局图形。
首先，我们先生成fig2:
```{r}
fig2 <- ggplot(data = data, aes(y = recent_life_satisfaction, x = factor(male))) +
  geom_violin() +
  ggtitle("recent_life_satisfaction \n By Respondent's gender") +
  xlab('male') +
  ylab('recent_life_satisfaction')
fig2
```
加上我们之前已经生成的fig1，我们可以对两张图片进行简单的布局，这时需要用到grid.arrange函数。如果我们想把2个图形分为两列放置，则：
```{r}
grid.arrange(fig1, fig2, ncol=2)
```
此处语法是grid.arrange(<图形名称1>,<图形名称2>.<图形名称3>,...,ncol=<数量>)。其中，ncol意为number of columns（列数）。通过以上代码，我们就能实现对把2个图形分两列布局。
当然，你也可以将其放在一列之内：
```{r}
grid.arrange(fig1, fig2, ncol=1)
```

# 图形分面（刻面）
当我们把如此多的数据汇总在单个图形中，难以观察不同地区的数据分布情况。如果想要对不同区域的数据做出比较，我们可以通过图形分面（facet，也称为刻面）来进行：
```{r}
ggplot(data = data, aes(x = recent_life_satisfaction)) +
  geom_histogram(fill = 'grey', color = 'black',bins = 10) +
  ggtitle('recent_life_satisfaction of Respondents \n By Region') +
  ylab('Density') +
  xlab('Gender') +
  theme_bw()+ # add theme here
  facet_wrap( ~ factor(region)) + # add facet here
  theme(plot.title = element_text(hjust = 0.5))
```
其中，我们新引入了facet_wrap函数，该函数的语法为facet_wrap(~<变量>, ncol=<数字>)。

# 调色板填充
用颜色区分不同数据组的需求比较大时，可以考虑直接将RColorBrewer包中的调色盘用scale_fill_brewer函数填充进入图形之中。
同样地，我们生成fig3：
```{r}
fig3 <- ggplot(data =data, aes(x = recent_life_satisfaction, color=factor(region), fill=factor(region))) +
  geom_histogram() +
  ggtitle('recent_life_satisfaction of Respondents \n By Region') +
  ylab('Density') +
  xlab('Gender') +
  theme_bw()+ # add theme here
  facet_wrap( ~ factor(region)) + # add facet here
  theme(plot.title = element_text(hjust = 0.5))
fig3
```
随后，我们选用Accent调色盘来对不同数据组进行填充：
```{r}
fig3 <- fig3 + scale_fill_brewer(palette = 'Accent')
fig3
```
怎么样，是不是为你节省了逐一填充色彩的时间呢？
要想了解关于scale_fill_brewer()的更多语法，就用代码呼唤help手册吧！
```{r}
?scale_fill_brewer()
```

### 基础可视化分析
针对不同的数据类型、分析方法，应该采用多样化的数据可视化方案。无论采取何种视觉呈现技术，都应该服务于让读者更加直观明了地获取数据信息。我们主要以单变量、双变量分析为例，向你展示数据可视化分析的基础选择策略和操作方法。

## 单变量分析

# 直方图（histogram）
直方图是一种展示定量数据分布的图形，可以通过观察直方图内不同矩形的面积大小来直观判断数据分布的大致情况。我们在上文中已经涉及到了对直方图的绘画，例如我们要展示recent_life_satisfaction of Respondents的数据分布：
```{r}
pic1 <- ggplot(data = data, aes(x = recent_life_satisfaction)) +
  geom_histogram() +
  xlab('recent_life_satisfaction') +
  ylab('') +
  ggtitle('recent_life_satisfaction of Respondents')
pic1
```
类似的，如果我们要展示househould_financial_satisfactiion的数据分布，你是否已经能够独立写出相应的代码了呢？
在此处，我们也提供一个示例：
```{r}
pic2 <- ggplot(data = data, aes(x = househould_financial_satisfactiion)) +
  geom_histogram() +
  xlab('househould_financial_satisfactiion') +
  ylab('') +
  ggtitle('househould_financial_satisfactiion')
pic2
```

## 双变量分析
双变量分析中，一般要注重呈现出两个变量的关心。由于数据的类型（离散、连续、有序、无序等等）和数据的规模（数十条、数千条、数万条……），需要依据实际效果选择最能够突出数据信息的可视化形式。何种方式适合呈现何种类型数据并无定式，不同的R使用者也各有其风格，不妨在起步阶段先都尝试一下吧！

# 散点图（point plot）
在散点图中，通过将两个变量设置为二维坐标，并以点的形式在坐标中标注数据的位置，我们用geom_point函数可以生成：
```{r}
pic3 <- ggplot(data = data, aes(x = househould_financial_satisfactiion, y = recent_life_satisfaction)) +
  geom_point() +
  xlab('househould_financial_satisfactiion') +
  ylab('recent_life_satisfaction') +
  ggtitle('Will househould_financial_satisfactiion predict recent_life_satisfaction')
pic3
```

# 抖动图（jitter plot）
当我们用散点图呈现数据时，有时会出现数据点位大量重合的情况，难以辨认某个区间的数据集中程度，这时可以使用抖动图来呈现数据。与散点图相同的是，抖动图也是在二维坐标中用点来表示数值；不同点在于，抖动图会让数值重合或者距离太近的点在图中稍微偏移原来的位置，在尽量不改变原点位置的前提下让每个点都能在图中显示出来。这就像摄影师为一群毕业生照相，会让个别毕业生挪动一下位置好把脸露出来是一个道理。通过geom_jitter函数，我们就能绘出抖动图：
```{r}
pic4 <- ggplot(data = data, aes(x = househould_financial_satisfactiion, y = recent_life_satisfaction)) +
  geom_jitter(width=0.1, height=0.3) +
  xlab('househould_financial_satisfactiion') +
  ylab('recent_life_satisfaction') +
  ggtitle('Will househould_financial_satisfactiion predict recent_life_satisfaction')
pic4
```
其中，width用于调节点的抖动宽度，height用于调节抖动点的高度。

# 添加拟合曲线
为了能更加一目了然地看出数据点的趋势，我们还能用stat_smooth函数拟合出一条平滑曲线来反映两个变量之间的关系：
```{r}
pic5 <- ggplot(data = data, aes(x = househould_financial_satisfactiion, y = recent_life_satisfaction)) +
  geom_jitter(width=0.2, height=0.2) +
  xlab('househould_financial_satisfactiion') +
  ylab('recent_life_satisfaction') +
  ggtitle('Will househould_financial_satisfactiion predict recent_life_satisfaction') +
  stat_smooth(color="grey")
pic5
```
在stat_smooth函数中，我们用color选项选择了用黑色画出曲线。
如何拟合出能够表现两个变量的关系的曲线，我们还能够在stat_smooth函数中选择相应的选项：
```{r}
pic6 <- ggplot(data = data, aes(x = househould_financial_satisfactiion, y = recent_life_satisfaction)) +
  geom_jitter(width=0.2, height=0.2) +
  xlab('househould_financial_satisfactiion') +
  ylab('recent_life_satisfaction') +
  ggtitle('Will househould_financial_satisfactiion predict recent_life_satisfaction') +
  stat_smooth(method = lm, color="grey")
pic6
```
method就是拟合方法选项，lm表示为线性回归，默认置信水平为95%。同样地，具体参数设置可以通过help手册查询。
## 内置连续色阶
当我们要通过颜色反映一个数值大小时，可以通过scale_color_contininuous函数设置所填充的色阶：
```{r}
pic7 <- ggplot(data = data, aes(x = househould_financial_satisfactiion, y = recent_life_satisfaction, color = househould_financial_satisfactiion)) +
  #scale_color_continuous(low="green")+
  scale_color_continuous(low ="green", high="red")+
  geom_jitter(width=0.2, height=0.2) +
  xlab('househould_financial_satisfactiion') +
  ylab('recent_life_satisfaction') +
  ggtitle('Will househould_financial_satisfactiion predict recent_life_satisfaction') +
  stat_smooth(method = lm, color="grey")
pic7
```
在scale_color-continuous函数中，low、与high选项的设置表示该色阶将从绿色渐变至红色，以表示数值的从低到高。
# 标点形状设置
我们继续在geom_jitter函数中增加选项，来丰富图形能够传递的数据信息：
```{r}
pic8 <- ggplot(data = data, aes(x = househould_financial_satisfactiion, y = recent_life_satisfaction, color = househould_financial_satisfactiion)) +
  #scale_color_continuous(low="green")+
  scale_color_continuous(low ="#CC0033", high="#0066CC")+
  geom_jitter(width=0.2, height=0.2, shape=factor(male), dotsize = male) + # dot style
  xlab('househould_financial_satisfactiion') +
  ylab('recent_life_satisfaction') +
  ggtitle('Will househould_financial_satisfactiion predict recent_life_satisfaction') +
  stat_smooth(method = lm, color="grey")
pic8
```
其中，shape和dotsize选项表示分别根据性别来更改点的形状和大小。
此处，我们还换了一种R能够读懂的16进制颜色通用代码，#CC0033为红色，#0066CC为蓝色，其他颜色代码可以在网络查询获得。
# 标点面积设置
我们还能用geom_count()函数来实现将该点的观测值映射为点的面积：
```{r}
pic9 <- ggplot(data = data, aes(x = househould_financial_satisfactiion, y = recent_life_satisfaction, color = househould_financial_satisfactiion)) +
  #scale_color_continuous(low="green")+
  scale_color_continuous(low ="#CC0033", high="#0066CC")+
  geom_count() +
  xlab('househould_financial_satisfactiion') +
  ylab('recent_life_satisfaction') +
  ggtitle('Will househould_financial_satisfactiion predict recent_life_satisfaction') +
  stat_smooth(method = lm, color="grey")
pic9
```

### 结语
到此，我们的数据可视化基础操作的章节就告一段落了。
ggplot2、gridExtra分别是图形生成、图形布局的优秀工具，在研究和工作中掌握好这两项技巧，一定能够帮助你把复杂的数据用简洁明了的图形呈现出来。虽然它们能够实现十分丰富的视觉效果，但一定记住数据可视化是为了让获取信息更直接，而不是为了让图片更美观。

如果大家想参考更多关于数据可视化学习的资料，可以通过下列我们推荐的链接浏览：
# https://stats.idre.ucla.edu/stat/data/intro_ggplot2_int/ggplot2_intro_interactive.html#(1)
# https://www.sohu.com/a/125919313_466874
