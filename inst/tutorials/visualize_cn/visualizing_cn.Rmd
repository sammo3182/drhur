---
title: "åŸºç¡€å¯è§†åŒ–"
subtitle: "Learning R with Dr. Hu and His Friends"
author: "èƒ¡æ‚¦ï¼ˆæ¸…åå¤§å­¦æ”¿æ²»å­¦ç³»ï¼‰"
output: 
  learnr::tutorial:
    language: "zh"
    progressive: true
    allow_skip: true
runtime: shiny_prerendered
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, message = FALSE, warning = FALSE)

library(learnr)
library(ggthemes) 
library(scales)
library(modelsummary)
library(dotwhisker)
library(interplot)
library(likert)
library(tidyverse)
library(gapminder)


set.seed(114)
```

# æ•°æ®å¯è§†åŒ–

## çŸ¥è¯†ç‚¹

- è‡ªå¸¦å¯è§†åŒ–
- `ggplot`
    - åŸºç¡€è¯­æ³•
    - ç»˜å›¾ä¸å˜æ¢
    - åŠŸèƒ½æ‰©å±•

## æ¼”ç¤ºæ•°æ®

æˆ‘ä»¬åœ¨è¿™éƒ¨åˆ†ä¾æ—§ä½¿ç”¨WVS7çš„ä¸€ä¸ªæ ·æœ¬è¿›è¡Œæ¼”ç¤ºã€‚
å…·ä½“å˜é‡ä¿¡æ¯å¯é€šè¿‡`?drhur::wvs7`æŸ¥çœ‹ã€‚

```{r wvs7}
library(drhur)
data("wvs7")
```

åœ¨ç½‘ç»œå’Œåœ°å›¾ç»˜åˆ¶è¿‡ç¨‹ä¸­ï¼Œè¿˜ä¼šç”¨åˆ°ä¸€äº›è½¯ä»¶åŒ…è‡ªå¸¦çš„æ•°æ®ã€‚
å› ä¸ºåªè¦å®‰è£…äº†è½¯ä»¶åŒ…å°±èƒ½ä½¿ç”¨ï¼Œå¾…åˆ°ç›¸å…³ç« èŠ‚æˆ‘ä»¬å†åšä»‹ç»ã€‚

## çŸ¥è¯†ç‚¹

+ ä»€ä¹ˆæ˜¯æ•°æ®å¯è§†åŒ–ï¼Ÿ

æ•°æ®å¯è§†åŒ–æŒ‡å°†æ•°å­—è®°å½•é—´**å…³ç³»**ä»¥äºŒç»´æˆ–ä¸‰ç»´å›¾å…·è±¡åŒ–çš„æŠ€æœ¯ã€‚

###

+ *The Grammar of Graphics* 

Leland Wilkinsonåˆ›é€ çš„é’ˆå¯¹å‡ ä¹æ‰€æœ‰ç±»å‹å®šé‡å¯è§†åŒ–ç³»ç»Ÿçš„åŸºç¡€æ€»ç»“ï¼Œè¯•å›¾æ¢ç©¶æ•°æ®å¯è§†åŒ–çš„åº•å±‚ç»“æ„ã€‚åœ¨Rä¸­æœ€æµè¡Œçš„å¯è§†åŒ–åŒ…`ggplot2`ï¼Œå°±æ˜¯å¯¹è¿™ä¸€ç†è®ºç³»ç»Ÿçš„å…¨é¢å‘ˆç°ã€‚

### 

+ å¯è§†åŒ–ç±»å‹

1. <span style="color:goldenrod">ç»Ÿè®¡å¯è§†åŒ–</span>
    + æè¿°æ€§~
    + åˆ†æ~
1. ç½‘ç»œå¯è§†åŒ–
    + å›¾è¡¨ ([`DiagrammeR`](https://rich-iannone.github.io/DiagrammeR/docs.html), [`semPlot`](http://sachaepskamp.com/semPlot/examples))
    + èŠ‚ç‚¹-è¿çº¿
1. åœ°å›¾

## Rå¯è§†åŒ–å¼•æ“

* åŸºæœ¬å›¾è¡¨: `plot()`
* æ …æ å›¾: e.g., `ggplot()`
* äº¤äº’å¼å›¾è¡¨: `shiny()` (ä»Šå¤©å…ˆä¸è®¨è®º)

###

### åŸºæœ¬å›¾è¡¨

```{r basePlot}
hist(mtcars$mpg)
```

**ä¼˜ç‚¹**

* Rä¸­è‡ªå¸¦
* <span style="color:goldenrod">æ¢ç´¢æ•°æ®</span>çš„ä¼˜è‰¯å·¥å…·ã€‚
+ <span style="color:goldenrod">ç©ºé—´</span>åˆ†æå’Œ <span style="color:goldenrod">3-D</span>å›¾ã€‚

**ç¼ºç‚¹**

* ä¸ç²¾è‡´
* çµæ´»æ€§å·®

**ä¿å­˜è¾“å‡º**

* å…¼å®¹æ¨¡å¼:`.jpg`, `.png`, `.wmf`, `.pdf`, `.bmp`, and `postscript`.
* è¿‡ç¨‹:
    1. å¯ç”¨è£…ç½®
    2. ç”»å›¾
    3. å…³é—­è£…ç½®

```{r saving, eval = FALSE}
png("<working directory>/histgraph.png")
hist(mtcars$mpg)
dev.off()
```

### `ggplot`

åœ¨Leland Wilkinsonçš„ *Grammar of Graphics*åŸºç¡€ä¸Šåˆ›å»ºã€‚

* ä¸ºäº†ä½¿ç”¨ `ggplot` å‡½æ•°, ä½ éœ€è¦å®‰è£…`ggplot2`.


```{r install, eval=FALSE}
install.packages("ggplot2")

# Or the development version from GitHub:
devtools::install_github("tidyverse/ggplot2")
```

## `ggplot`æ ¸å¿ƒæ¦‚å¿µ

* `mapping`: ç¾è§‚æ˜ å°„ (`aes`, `alpha`)---é¢œè‰², å½¢çŠ¶, å¤§å°
    + ä»ä¸€å¹…å›¾ä¸­å¯ä»¥æ„ŸçŸ¥åˆ°çš„æ€§è´¨ã€‚
    + æ¯ä¸€ç§ç¾è§‚æ€§å¯ä»¥è¢«æ˜ å°„åˆ°ä¸€ä¸ªå˜é‡ï¼Œæˆ–æ˜¯è¢«è®¾ç½®æˆä¸€ä¸ªå¸¸é‡ã€‚
* `geom_`: å‡ ä½•å›¾æ¡ˆ---ç‚¹, çº¿, æ¡
    + å››åä½™ç§

```{r out.width = "100%", echo = FALSE}
knitr::include_graphics("images/ggplot_geom.png")
```

## ä¸‡èƒ½æ¨¡æ¿

```{r basic, eval = FALSE}
ggplot(___) +
  geom_point(
    mapping = aes(x = ___, y = ___,
                  color = ___,
                  size  = ___),
    alpha  = ___
  )
```

> èŒèŒï¼šå…¶å®ggplotä½œå›¾å’Œæˆ‘ä»¬å¸¸è§çš„PSä¿®å›¾å¾ˆåƒï¼Œå…ˆæŠŠåŸºæœ¬å›¾åšå‡ºæ¥ï¼Œç„¶åä¸€å±‚ä¸€å±‚å åŠ æ»¤é•œæ•ˆæœã€‚

## æè¿°å¯è§†åŒ–

ä¸€ç”ŸäºŒï¼ŒäºŒç”Ÿä¸‰ï¼Œä¸‰ç”Ÿä¸‡å¼ å›¾ã€‚

æ­¤æ¬¡è¯¾ç¨‹æˆ‘ä»¬å°†ç”¨ä»¥ä¸‹ä¸‰ä¸ªä¾‹å­æ¼”ç¤ºå¦‚ä½•åœ¨Rä¸­è¿›è¡Œç»Ÿè®¡åˆ†æã€‚

1. Gapminder 2007 (ç‚¹çŠ¶å›¾)
2. æ–°å† ç—…æ¯’è‡´æ­»ç‡ (æŸ±çŠ¶å›¾)
3. æ–°å† ç—…æ¯’æ½œä¼æœŸ (æ‰‡å½¢å›¾)

```{r goal-plots, results="hide", out.width="100%", echo=FALSE}
if (!require(ggplot2)) install.packages("ggplot2")
if (!require(scales)) install.packages("scales")
if (!require(ggthemes)) install.packages("ggthemes")
if (!require(gapminder)) install.packages("gapminder")

library(ggplot2) #ä¸»è¦ç»˜å›¾å·¥å…·
library(ggthemes) #ggthemesæ˜¯ggplot2çš„ä¸€ä¸ªæ‰©å±•åŒ…ï¼Œæä¾›ä¸€äº›é¢å¤–çš„themesã€geomsã€scalesã€‚
library(scales)
library(gapminder) 

gapminder_2007 <- filter(gapminder, year == 2007) #é€‰å‡ºå¹´ä»½ä¸º2007å¹´çš„æ•°æ®

ggplot(gapminder_2007) +
  geom_point(aes(x = gdpPercap, y = lifeExp, size = pop,
                 color = continent),
             alpha = 0.5) #åˆ†åˆ«ä»¥äººå‡GDPå’Œç”Ÿå‘½é¢„æœŸä¸ºæ¨ªçºµè½´ï¼Œç‚¹çš„å¤§å°è¡¨ç¤ºäººå£è§„æ¨¡ï¼Œç‚¹çš„é¢œè‰²è¡¨ç¤ºæ‰€åœ¨å¤§æ´²ï¼Œé€æ˜åº¦ä¸º0.5

ggplot(cfr_china, aes(x=age, y=cfr, group=1)) +
  geom_line() + #æŠ˜çº¿å›¾
  geom_hline(yintercept = 0.01 * 2.3, linetype="dashed", alpha=0.5) + #æ·»åŠ æ¨ªçº¿
  geom_bar(aes(width=cases/10000, fill=age), stat = "identity", position = "identity") + #æŸ±çŠ¶å›¾
  geom_text(aes(label=paste0(cfr*100,"%")), family="Palatino", size=3, nudge_y = 0.04) + #æ·»åŠ æ–‡æœ¬ï¼Œå…¶ä¸­familyè¡¨ç¤ºå­—ä½“ï¼Œsizeä¸ºå­—ä½“å¤§å°
  geom_text(aes(label=paste0("(",deaths,"/",cases,")")), family="Palatino", size=3, nudge_y = 0.03) +
  scale_y_continuous(labels = percent) +
  scale_fill_tableau(palette = "Classic 10 Medium") +
  labs(title = "COVID-19 Case Fatality Rate (CFR) by Age Groups",
       subtitle = "Among 44,672 confirmed cases in China through February 11\nOverall CFR = 2.3% (dotted line)", #æ·»åŠ æ ‡é¢˜
       x = "Age Group", y = NULL,
       caption = "Source: Characteristics of and Important Lessons From the Coronavirus Disease 2019 (COVID-19) Outbreak in China:\nSummary of a Report of 72314 Cases From the Chinese Center for Disease Control and Prevention. Wu Z, McGoogan JM. JAMA. 2020\nhttps://jamanetwork.com/journals/jama/fullarticle/2762130 and http://weekly.chinacdc.cn/en/article/id/e53946e2-c6c4-41e9-9a9b-fea8db1a8f51") +
  theme_minimal(base_size = 14, base_family = "Palatino") +
  theme(plot.caption = element_text(face = "italic", size=6),
        legend.position = "none") #ä¸»é¢˜


ggplot(incubation_data, aes(ymax = svalue, ymin = 0, xmax = 2, xmin = 1, fill = sname)) +
  geom_rect(aes(ymax=14, ymin=0, xmax=2, xmin=1), fill ="#ece8bd") +
  geom_rect() +
  coord_polar(theta = "y",start=-pi/2) +
  xlim(c(0, 2)) + ylim(c(0,28)) +
  scale_fill_few(palette = "Medium") +
  scale_color_few(palette = "Medium") +
  geom_text(aes(x = 0, y = 0, label=stext, colour=sname), size=4, family="Palatino") +
  facet_wrap(~sname, ncol = 3) + #åˆ†é¢
  guides(fill=FALSE, colour=FALSE) +
  labs(title="COVID-19 Incubation Time",
       subtitle = "Time before infected person becomes symptomatic\n (percentiles and mean) ",
       caption = "Source: COVID-19 Incubation Period: An Update. Stephen G. Baum, MD\n reviewing Lauer SA et al. Ann Intern Med 2020 Mar 10\nhttps://www.jwatch.org/na51083/2020/03/13/covid-19-incubation-period-update",
       x=NULL, y=NULL) +
  theme_tufte(ticks = FALSE, base_size = 12, base_family = "Palatino") +
  theme(axis.text = element_blank(),
        plot.caption = element_text(face = "italic", size=6),
        strip.text = element_text(size = 12))
```


## æ¡ˆä¾‹1: å›¾å½¢å±æ€§

```{r pointGoal,echo=FALSE}
library(gapminder)

gapminder_2007 <- filter(gapminder, year == 2007)

ggplot(gapminder_2007) +
  geom_point(aes(x = gdpPercap, y = lifeExp, size = pop,
                 color = continent),
             alpha = 0.5)
```


### æ­å»ºæ‹†è§£

```{r point, exercise = TRUE}
library(gapminder)

gapminder_2007 <- filter(gapminder, year == 2007)

ggplot(gapminder_2007) +
  geom_point(aes(x = gdpPercap, y = lifeExp))
```

```{r point-solution}
# è°ƒæ•´é¢œè‰²
ggplot(gapminder_2007) +
  geom_point(aes(x = gdpPercap, y = lifeExp,
                 color = continent))

ggplot(gapminder_2007) +
  geom_point(aes(x = gdpPercap, y = lifeExp,
                 color = pop))

# è°ƒæ•´å¤§å°
ggplot(gapminder_2007) +
  geom_point(aes(x = gdpPercap, y = lifeExp,
                 size = pop)) +
  scale_size_area(max_size = 10)

# è°ƒæ•´é€æ˜åº¦
ggplot(gapminder_2007) +
  geom_point(aes(x = gdpPercap, y = lifeExp, size = pop),
             alpha = 0.5)

# ç»„åˆ

ggplot(gapminder_2007) +
  geom_point(aes(x = gdpPercap, y = lifeExp, size = pop,
                 color = continent),
             alpha = 0.5)
```

> èŒèŒï¼šå¯ä»¥çœ‹å‡ºï¼Œä¸€å¼ ç»Ÿè®¡å›¾å½¢æ˜¯ç”±ä»æ•°æ®åˆ°å‡ ä½•å¯¹è±¡ï¼ˆgeometric objectï¼Œè®°ä¸ºgeomï¼Œå¦‚ç‚¹ï¼Œçº¿ï¼Œæ¡å½¢ç­‰ï¼‰ï¼Œå›¾å½¢å±æ€§ï¼ˆaesthetic attributesï¼Œè®°ä¸ºaesï¼Œå¦‚é¢œè‰²ï¼Œå½¢çŠ¶ï¼Œå¤§å°ï¼‰çš„ä¸€ä¸ªæ˜ å°„ã€‚è¿™äº›ç»„ä»¶ä¹‹é—´é€šè¿‡â€œ+â€, ä»¥å›¾å±‚(layer)çš„æ–¹å¼æ¥ç²˜åˆæ„å›¾ã€‚

## æ¡ˆä¾‹2: å‡ ä½•å›¾å±‚

```{r cfr-df, echo = FALSE}
# Case Fatality Rate

cfr_china
```

```{r cfr-plot, echo = FALSE}
if (!require(ggplot2)) install.packages("ggplot2")
if (!require(scales)) install.packages("scales")
if (!require(ggthemes)) install.packages("ggthemes")

library(ggplot2)
library(scales)
library(ggthemes)

ggplot(cfr_china, aes(x=age, y=cfr, group=1)) +
  geom_line() +
  geom_hline(yintercept = 0.01 * 2.3, linetype="dashed", alpha=0.5) +
  geom_bar(aes(width=cases/10000, fill=age), stat = "identity", position = "identity") +
  geom_text(aes(label=paste0(cfr*100,"%")), family="Palatino", size=3, nudge_y = 0.04) +
  geom_text(aes(label=paste0("(",deaths,"/",cases,")")), family="Palatino", size=3, nudge_y = 0.03) +
  scale_y_continuous(labels = percent) +
  scale_fill_tableau(palette = "Classic 10 Medium") +
  labs(title = "COVID-19 Case Fatality Rate (CFR) by Age Groups",
       subtitle = "Among 44,672 confirmed cases in China through February 11\nOverall CFR = 2.3% (dotted line)",
       x = "Age Group", y = NULL,
       caption = "Source: Characteristics of and Important Lessons From the Coronavirus Disease 2019 (COVID-19) Outbreak in China:\nSummary of a Report of 72314 Cases From the Chinese Center for Disease Control and Prevention. Wu Z, McGoogan JM. JAMA. 2020\nhttps://jamanetwork.com/journals/jama/fullarticle/2762130 and http://weekly.chinacdc.cn/en/article/id/e53946e2-c6c4-41e9-9a9b-fea8db1a8f51") +
  theme_minimal(base_size = 14, base_family = "Palatino") +
  theme(plot.caption = element_text(face = "italic", size=6),
        legend.position = "none")
```

>èŒèŒï¼š`ggplot2`æä¾›äº†`ggtitle()`, `xlab()`å’Œ`ylab()`æ¥æ˜¾ç¤ºå‡ºå›¾æ ‡é¢˜ï¼Œxè½´ï¼Œyè½´ã€‚é™¤æ­¤ä¹‹å¤–ï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡`theme()`å‡½æ•°
æ ¹æ®éœ€è¦æ¥æ”¹å˜å­—ä½“ï¼Œå­—ä½“å¤§å°ï¼Œåæ ‡è½´ï¼ŒèƒŒæ™¯ç­‰å„ç§å…ƒç´ ã€‚å¦‚,`theme_grey()`ä¸ºé»˜è®¤ä¸»é¢˜ï¼Œ`theme_bw()`ä¸ºç™½è‰²èƒŒæ™¯çš„ä¸»é¢˜ã€‚

### æ­å»ºæ‹†è§£

```{r steps, exercise = TRUE}
if (!require(ggplot2)) install.packages("ggplot2")
if (!require(scales)) install.packages("scales")
if (!require(ggthemes)) install.packages("ggthemes")

library(ggplot2)
library(scales)
library(ggthemes)

ggplot(data = cfr_china,
       aes(x = age, y = cfr, group = 1))
```

```{r steps-solution}
ggplot(data = cfr_china,
       aes(x = age, y = cfr, group = 1)) +
  geom_bar(aes(width = cases / 10000, fill = age),
           stat = "identity",
           position = "identity") +
  geom_hline(yintercept = 0.01 * 2.3,
             linetype = "dashed",
             alpha = 0.5) +
  geom_line() +
  geom_text(
    aes(label = paste0(cfr * 100, "%")),
    family = "Palatino",
    size = 3,
    nudge_y = 0.04
  ) +
  geom_text(
    aes(label = paste0("(", deaths, "/", cases, ")")),
    family = "Palatino",
    size = 3,
    nudge_y = 0.03
  ) +
  scale_y_continuous(labels = percent) +
  scale_fill_tableau(palette = "Classic 10 Medium") +
  labs(
    title = "COVID-19 Case Fatality Rate (CFR) by Age Groups",
    subtitle = "Among 44,672 confirmed cases in China through February 11\nOverall CFR = 2.3% (dotted line)",
    x = "Age Group",
    y = NULL,
    caption = "Source: Characteristics of and Important Lessons From the Coronavirus Disease 2019 (COVID-19) Outbreak in China:\nSummary of a Report of 72314 Cases From the Chinese Center for Disease Control and Prevention. Wu Z, McGoogan JM. JAMA. 2020\nhttps://jamanetwork.com/journals/jama/fullarticle/2762130 and http://weekly.chinacdc.cn/en/article/id/e53946e2-c6c4-41e9-9a9b-fea8db1a8f51"
  ) +
  theme_minimal(base_size = 14, base_family = "Palatino") +
  theme(plot.caption = element_text(face = "italic", size = 6),
        legend.position = "none")
```

> èŒèŒï¼šæ¯ä¸€ç§å›¾å½¢å±æ€§éƒ½æœ‰ä¸€ä¸ªé»˜è®¤çš„æ ‡åº¦,`scale_`ä¾¿æ˜¯å°†æ•°æ®ç©ºé—´ï¼ˆæ ‡åº¦çš„å®šä¹‰åŸŸï¼‰æ˜ å°„åˆ°å›¾å½¢å±æ€§ç©ºé—´ï¼ˆæ ‡åº¦çš„å€¼åŸŸï¼‰çš„å¸¸ç”¨å‡½æ•°ã€‚å¦‚ï¼Œç¦»æ•£æ€§æ•°æ®çš„é¢œè‰²å›¾å½¢å±æ€§é»˜è®¤æ ‡åº¦åä¸º`scale_colour_hue()`ï¼Œå½¢çŠ¶å›¾å½¢å±æ€§æ ‡åº¦ä¸º`scale_shape_shape()`ã€‚


### åˆæ­¥æ€»ç»“

* `data`: ä½ æƒ³è¦å¯è§†åŒ–çš„æ•°æ®
* `aes`: ç¾å­¦æ˜ å°„
* `geoms`: å‡ ä½•å¯¹è±¡
* `labs`:
    + `title, subtitle`: æ ‡é¢˜
    + `x, y`: åæ ‡è½´æ ‡ç­¾
    + `caption`: ç¬”è®°
+ `stats`: ç»Ÿè®¡è½¬æ¢
+ `scales`: å°†æ•°æ®ä¸æ˜ å°„è”ç³»èµ·æ¥
    + `coord`: ä¸€ä¸ªæè¿°æ•°æ®åæ ‡å¦‚ä½•æ˜ å°„åˆ°å›¾å½¢å¹³é¢çš„åæ ‡ç³»ç»Ÿã€‚
    + `facet`: ä¸€ä¸ªæ„é¢è§„èŒƒæè¿°äº†å¦‚ä½•å°†æ•°æ®åˆ†è§£ä¸ºé›†åˆã€‚
* `theme`: èƒŒæ™¯


### ä¿å­˜è¾“å‡º

* `ggsave(<plot project>, "<name + type>")`:
    + å½“çœç•¥`<plot project>`æ—¶ï¼ŒRå°†ä¿å­˜æœ€åæ˜¾ç¤ºçš„å›¾ã€‚
    + ç”¨æˆ·è¿˜å¯ä»¥ä½¿ç”¨å…¶ä»–å‚æ•°æ¥è°ƒæ•´å¤§å°ï¼Œè·¯å¾„ï¼Œæ¯”ä¾‹ç­‰ã€‚

```{r save, eval = FALSE}
ggsave("cfr.png")
```

## æ¡ˆä¾‹3: æ–°å† ç—…æ¯’æ½œä¼æœŸ

```{r incubation-df, echo = FALSE}
incubation_data %>%
  mutate(sname = c("0%", "2.5%", "50%", "Average", "97.5%", "100%"),
         stext = str_sub(stext, start = 2))
```

```{r incubation-plot, echo = FALSE}
ggplot(incubation_data, aes(ymax = svalue, ymin = 0, xmax = 2, xmin = 1, fill = sname)) +
  geom_rect(aes(ymax=14, ymin=0, xmax=2, xmin=1), fill ="#ece8bd") +
  geom_rect() +
  coord_polar(theta = "y",start=-pi/2) +
  xlim(c(0, 2)) + ylim(c(0,28)) +
  scale_fill_few(palette = "Medium") +
  scale_color_few(palette = "Medium") +
  geom_text(aes(x = 0, y = 0, label=stext, colour=sname), size=4, family="Palatino") +
  facet_wrap(~sname, ncol = 3) +
  guides(fill=FALSE, colour=FALSE) + # removed the legend
  labs(title="COVID-19 Incubation Time",
       subtitle = "Time before infected person becomes symptomatic\n(percentiles and mean) ",
       caption = "Source: COVID-19 Incubation Period: An Update. Stephen G. Baum, MD\n reviewing Lauer SA et al. Ann Intern Med 2020 Mar 10\nhttps://www.jwatch.org/na51083/2020/03/13/covid-19-incubation-period-update",
       x=NULL, y=NULL) +
  theme_tufte(ticks = FALSE, base_size = 12, base_family = "Palatino") +
  theme(axis.text = element_blank(),
        plot.caption = element_text(face = "italic", size=6),
        strip.text = element_text(size = 12))
```

> èŒèŒï¼š`facet_wrap`å’Œ`facet_grid`æ˜¯`ggplot2`å¸¸ç”¨åˆ°çš„åˆ†é¢å‡½æ•°ï¼Œåœ¨æ•°æ®å¯¹æ¯”ä»¥åŠåˆ†ç±»æ˜¾ç¤ºä¸Šæœ‰ç€æä¸ºé‡è¦çš„ä½œç”¨ã€‚

### æ­å»ºæ‹†è§£

```{r incubation, exercise = TRUE}
ggplot(incubation_data,
       aes(
         ymax = svalue,
         ymin = 0,
         xmax = 2,
         xmin = 1,
         fill = sname
       ))
```

```{r incubation-solution}
ggplot(incubation_data,
       aes(
         ymax = svalue,
         ymin = 0,
         xmax = 2,
         xmin = 1,
         fill = sname
       )) +
  geom_rect(aes(
    ymax = 14,
    ymin = 0,
    xmax = 2,
    xmin = 1
  ), fill = "#ece8bd") +
  geom_rect() +
  coord_polar(theta = "y", start = -pi / 2) +
  xlim(c(0, 2)) + ylim(c(0, 28)) +
  scale_fill_few(palette = "Medium") +
  scale_color_few(palette = "Medium") +
  geom_text(aes(
    x = 0,
    y = 0,
    label = stext,
    colour = sname
  ),
  size = 4,
  family = "Palatino") +
  facet_wrap( ~ sname, ncol = 3) +
  guides(fill = FALSE, colour = FALSE) +
  labs(
    title = "COVID-19 Incubation Time",
    subtitle = "Time before infected person becomes symptomatic\n(percentiles and mean) ",
    caption = "Source: COVID-19 Incubation Period: An Update. Stephen G. Baum, MD\n reviewing Lauer SA et al. Ann Intern Med 2020 Mar 10\nhttps://www.jwatch.org/na51083/2020/03/13/covid-19-incubation-period-update",
    x = NULL,
    y = NULL
  ) +
  theme_tufte(ticks = FALSE,
              base_size = 12,
              base_family = "Palatino") +
  theme(
    axis.text = element_blank(),
    plot.caption = element_text(face = "italic", size = 6),
    strip.text = element_text(size = 12)
  )
```



## åˆ†æå¯è§†åŒ–

* Likerté‡è¡¨
* å›å½’ç³»æ•°
* äº¤äº’æ•ˆåº”
* åœ°å›¾

###

```{r data-likert, echo=FALSE}
df_likert
```


## æ¡ˆä¾‹1ï¼šLikert-ScaleæŒ‡æ•°

```{r likert, exercise = TRUE, exercise.eval = TRUE}
if (!require(likert)) install.packages("likert")
library(likert)

likert(df_likert) %>%
  plot(type = "bar")
```

```{r likert-solution}
 likert(df_likert) %>%
  plot(
    type = "heat",
    low.color = "white",
    high.color = "blue",
    text.color = "black", 
    text.size = 4,
    wrap = 50
  )

likert(df_likert) %>%
  plot(type = "density",
       facet = TRUE,
       bw = 0.5)
```

## æ¡ˆä¾‹2ï¼šå›å½’ç»“æœ

### ç³»æ•°å¯è§†åŒ–

```{r m1}
m1 <- lm(mpg ~ cyl + gear + wt, data = mtcars) #è¿›è¡ŒOLSå›å½’

summary(m1)
```

### æ’æ’­ï¼šåˆ¶è¡¨ä¹‹çœŸPublishable

```{r modeltable}
library(modelsummary)
library(gt)

modelsummary(m1,
         stars = TRUE,
         title =  gt::md('This is *the* title'),
         subtitle = 'And a subtitle',
         output = "gt") %>% 
  tab_style(style = cell_fill(color = 'lightblue'),
              locations = cells_body(rows = 7:8))
```

> èŒèŒï¼š`modelssummary`å¯ä»¥è‡ªå®šä¹‰å›å½’ç»“æœè¡¨ä¸­æ˜¾ç¤ºçš„ä¿¡æ¯ã€‚å¦‚ï¼Œé‡å‘½åã€é‡æ–°æ’åº é€‰æ‹©è¦æ˜¾ç¤ºçš„æ‹Ÿåˆä¼˜åº¦ï¼› æ˜¾ç¤ºå„ç§â€œç¨³å¥â€æ ‡å‡†è¯¯å·®æˆ–ç½®ä¿¡åŒºé—´ï¼›æ·»åŠ æ ‡é¢˜ã€è„šæ³¨æˆ–æºæ³¨é‡Šï¼› æ’å…¥æ˜Ÿå·æˆ–è‡ªå®šä¹‰å­—ç¬¦ä»¥æŒ‡ç¤ºç»Ÿè®¡æ˜¾ç€æ€§æ°´å¹³ã€‚

```{r modelOut, eval = FALSE}
modelsummary(models, filename = 'table.tex')
modelsummary(models, filename = 'table.rtf')
modelsummary(models, filename = 'table.html')
modelsummary(models, filename = 'table.jpeg')
modelsummary(models, filename = 'table.png')
```

### Dot-whisker plot

```{r dotwhisker}
if (!require(dotwhisker)) install.packages("dotwhisker")
library(dotwhisker)

dwplot(m1)
```

> èŒèŒï¼š`dotwhisker`èƒ½å¤Ÿå¿«é€Ÿç»˜åˆ¶å›å½’ç»“æœå›¾ã€‚

### å¤šé‡æ¨¡å‹

```{r dwMulti, exercise = TRUE, exercise.eval = TRUE}
m2 <- lm(mpg ~ cyl + hp + wt + hp, data = mtcars)
m3 <- lm(mpg ~ cyl + hp + wt + hp + am, data = mtcars)

dwplot(list(m1, m2, m3)) #å¤šä¸ªå›å½’ç»“æœå¯è§†åŒ–
```

```{r dwMulti-solution}
dwplot(list(m1, m2, m3)) %>%
  relabel_predictors(
    c(
      wt = "Weight",
      cyl = "Cylinders",
      disp = "Displacement",
      hp = "Horsepower",
      gear = "Gears",
      am = "Manual"
    ) #é‡æ–°å‘½åçºµè½´
  ) +
  theme_bw() + xlab("Coefficient Estimate") + ylab("") + #æ·»åŠ æ¨ªè½´æ ‡é¢˜
  geom_vline(xintercept = 0, #åœ¨x=0å‡ºæ·»åŠ è™šçº¿
             colour = "grey60", #çº¿çš„é¢œè‰²
             linetype = 2) + #çº¿çš„ç±»å‹
  ggtitle("Predicting Gas Mileage") + #åŠ å…¥æ ‡é¢˜
  theme(
    plot.title = element_text(face = "bold"),
    legend.justification = c(0, 0),
    legend.position = c(0, 0),
    legend.background = element_rect(colour = "grey80"), 
    legend.title = element_blank() #å»æ‰ç°è‰²ç½‘æ ¼
  )
```


### Small_multiple

```{r smallMultiple,eval=FALSE}
small_multiple(list(m1, m2, m3)) +
  ylab("Coefficient Estimate") +
  geom_hline(yintercept = 0,
             colour = "grey60",
             linetype = 2) +
  ggtitle("Predicting Gas Mileage") +
  theme(
    plot.title = element_text(face = "bold"),
    legend.position = "none",
    axis.text.x  = element_text(angle = 60, hjust = 1)
  )
```


## æ¡ˆä¾‹3ï¼šäº¤äº’æ•ˆåº”

`interplot` ![](http://cranlogs.r-pkg.org/badges/grand-total/interplot)

ç”¨åŒå‘äº¤äº’çš„æ–¹å¼å¯è§†åŒ–ä¸­ä¸€ä¸ªå˜é‡çš„ç³»æ•°å˜åŒ–å–å†³äºå¦ä¸€ä¸ªè¢«åŒ…å«çš„å˜é‡çš„å€¼ã€‚

###

* ï¼ˆè€è¥é”€styleğŸ˜ï¼‰æƒŠå¤©æ­ç§˜ï¼å•çœ‹æ˜¾è‘—æ€§æ— æ³•æ­£ç¡®è§£é‡Šäº¤äº’æ•ˆåº”ï¼
    + æ¨¡å‹: $$Y = \beta_0 + \beta_1X + \beta_2Z + \beta_3X\times Z + \varepsilon.$$
    + å½±å“: $$\frac{\partial Y}{\partial X} = \beta_1 + \beta_3Z.$$
    + æ ‡å‡†å·®: $$\hat{\sigma}_{\frac{\partial Y}{\partial X}} = \sqrt{var(\hat{\beta_1}) + Z^2var(\hat{\beta_3}) + 2Zcov(\hat{\beta_1}, \hat{\beta_3})}.$$

* å¦‚ä½•æ‰èƒ½æ­£ç¡®ç†è§£ï¼Ÿ
    + æœ€ç²¾ç¡®çš„æ–¹å¼: è®¡ç®—å¹³å‡æ•°å’Œæ ‡å‡†å·®ä¹‹é—´çš„å·®å€¼ã€‚
    + æœ€æ–¹ä¾¿çš„æ–¹å¼ï¼šæŠŠå®ƒå¯è§†åŒ–

### ç»˜åˆ¶äº¤äº’æ•ˆåº”

```{r interact, exercise = TRUE, exercise.eval = TRUE}
m_cyl <- lm(mpg ~ wt * cyl, data = mtcars)
summary(m_cyl)
```

```{r interact-solution}
if (!require(interplot)) install.packages("interplot")
library(interplot)

interplot(m = m_cyl, var1 = "cyl", var2 = "wt")
interplot(m = m_cyl, var1 = "wt", var2 = "cyl")
```

### å®è´¨æ˜¾è‘—æ€§

```{r interHist}
interplot(m = m_cyl, var1 = "cyl", var2 = "wt", hist = TRUE) +
    geom_hline(yintercept = 0, linetype = "dashed")
```

### ç±»åˆ«æ¯”è¾ƒ

```{r interFactor}
mtcars$gear <- factor(mtcars$gear)
m_gear <- lm(mpg ~ gear * wt, data = mtcars)

interplot(m = m_gear, var1 = "wt", var2 = "gear")
```


## ç½‘ç»œå¯è§†åŒ–

```{r network}
if (!require(network)) install.packages("network")
if (!require(sna)) install.packages("sna")

library(network)
library(sna)
n <- network(rgraph(10, tprob = 0.2), directed = FALSE)

n %v% "family" <- sample(letters[1:3], 10, replace = TRUE)
n %v% "importance" <- sample(1:3, 10, replace = TRUE)

e <- network.edgecount(n)
set.edge.attribute(n, "type", sample(letters[24:26], e, replace = TRUE))
set.edge.attribute(n, "day", sample(1:3, e, replace = TRUE))

if (!require(ggnetwork)) install.packages("ggnetwork")
library(ggnetwork)

ggplot(n, aes(x = x, y = y, xend = xend, yend = yend)) +
  geom_edges(aes(linetype = type), color = "grey50") +
  geom_nodes(aes(color = family, size = importance)) +
  theme_blank()
```

## åœ°ç†å¯è§†åŒ–

```{r map, message=FALSE, cache=TRUE}
if (!require(ggmap)) install.packages("ggmap")
library(ggmap)

china <- c(left = 72, bottom = 0, right = 135, top = 52)

get_stamenmap(china, zoom = 5, maptype = "toner-lite") %>%
  ggmap()
```

> èŒèŒï¼š`ggmap`å’Œ`ggplot2`ä¸€æ ·å¯ä»¥å®ç°å›¾å½¢çš„åˆ†å±‚è¯­æ³•ï¼Œå…¶åŸºæœ¬æ€è·¯æ˜¯ä½¿ç”¨ä¸‹è½½çš„åœ°å›¾å›¾åƒï¼ŒåŒæ—¶ä½¿ç”¨ggplot2å°†å…¶ä½œä¸ºèƒŒæ™¯å±‚ï¼Œç„¶ååœ¨åœ°å›¾ä¸Šç»˜åˆ¶æ•°æ®ï¼Œç»Ÿè®¡ä¿¡æ¯æˆ–æ¨¡å‹ç­‰å›¾å±‚ã€‚

## æ€»ç»“

1. å¥½çœ‹ &prop; å¤æ‚æ€§ã€‚
1. æ›´é…·ç‚«ä¸æ„å‘³ç€æ›´å¥½ã€‚

